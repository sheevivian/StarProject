@model StarProject.ViewModels.ParticipantsIndexVm
@using StarProject.ViewModels

@{
    ViewData["Title"] = "報名管理";
    var cards = Model?.Cards ?? new List<EventCardVm>();
}

<!-- Debug -->
<div class="text-white small">DEBUG cards.Count = @cards.Count</div>

<!-- 標題 & 匯出「全部」 -->
<div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="fw-bold text-white">報名管理</h1>
    <div class="d-flex gap-2">
        <a class="btn btn-outline-light" asp-controller="Participants" asp-action="ExportExcel">匯出全部 Excel</a>
        <a class="btn btn-outline-light" asp-controller="Participants" asp-action="ExportCsv">匯出全部 CSV</a>
    </div>
</div>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success">@TempData["Success"]</div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}

<!-- 卡片網格（組員風格） -->
<section class="wrapper">
    <div class="container">
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4" id="eventCardGrid">
            @if (!cards.Any())
            {
                <div class="col-12">
                    <div class="alert alert-warning">目前沒有可顯示的活動。</div>
                </div>
            }
            else
            {
                @foreach (var e in cards)
                {
                    // 背景圖處理
                    var raw = e.CoverImageUrl ?? "";
                    string bg;
                    if (string.IsNullOrWhiteSpace(raw))
                    {
                        bg = "https://images.unsplash.com/photo-1444703686981-a3abbc4d4fe3?q=80&w=1400&auto=format&fit=crop";
                    }
                    else if (raw.StartsWith("http", StringComparison.OrdinalIgnoreCase))
                    {
                        bg = raw;
                    }
                    else
                    {
                        var normalized = (raw.StartsWith("~/") || raw.StartsWith("/")) ? raw : $"~/uploads/{raw}";
                        bg = Url.Content(normalized);
                    }

                    <div class="col">
                        <div class="card text-dark card-has-bg cardDetail h-100"
                             style="background-image:url('@bg');"
                             data-event-id="@e.No"
                             data-event-title="@e.Title"
                             data-bs-toggle="modal"
                             data-bs-target="#participantsModal"
                             role="button"
                             aria-label="檢視 @e.Title 的報名名單">
                            <img class="card-img d-none" src="@bg" alt="@e.Title" />
                            <div class="card-img-overlay d-flex flex-column">
                                <div class="card-body">
                                    <small class="card-meta mb-2">@e.Category</small>
                                    <h4 class="card-title mt-0 text-dark text-truncate">@e.Title</h4>
                                    <small class="d-block">
                                        <i class="far fa-clock me-1"></i>@e.StartDate.ToString("yyyy/MM/dd HH:mm")
                                    </small>
                                </div>
                                <div class="card-footer">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div class="d-flex align-items-center gap-2">
                                            <i class="bi bi-people"></i>
                                            <span>@e.CurrentCount / @e.MaxParticipants 人</span>
                                        </div>
                                        <div class="d-flex align-items-center gap-2">
                                            <i class="bi bi-geo-alt"></i>
                                            <small class="text-truncate" style="max-width:160px">@e.Location</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div> <!-- /card -->
                    </div> <!-- /col -->
                }
            }
        </div>
    </div>
</section>

<!-- Modal：顯示單一活動的參與者名單 -->
<div class="modal fade" id="participantsModal" tabindex="-1" aria-labelledby="participantsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h4 class="modal-title fw-bold mb-1" id="participantsModalLabel">參與者名單</h4>
                    <div class="small text-muted" id="participantsModalSub">活動編號：<span id="modalEventId">-</span></div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="關閉"></button>
            </div>

            <div class="modal-body">
                <!-- 工具列：單一活動匯出、批次刪除 -->
                <div class="d-flex align-items-center gap-2 mb-3">
                    <a class="btn btn-outline-primary" id="btnExportCsv" target="_blank" rel="noopener">
                        <i class="fa-solid fa-file-csv me-1"></i> 匯出 CSV（本活動）
                    </a>
                    <a class="btn btn-outline-success" id="btnExportExcel" target="_blank" rel="noopener">
                        <i class="fa-solid fa-file-excel me-1"></i> 匯出 Excel（本活動）
                    </a>

                    <form id="bulkForm" class="ms-auto">
                        @Html.AntiForgeryToken()
                        <button type="button" class="btn btn-outline-danger" id="btnBulkDelete">
                            <i class="fa-solid fa-trash-can me-1"></i> 刪除已勾選
                        </button>
                    </form>
                </div>

                <!-- 名單容器（AJAX 載入 _ParticipantsTable 部分檢視） -->
                <div id="participantsTableContainer" class="border rounded p-2 position-relative" style="min-height:180px">
                    <div class="text-center text-muted py-5" id="tableLoading">
                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                        載入中…
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 樣式 -->
@section Styles {
    <style>
        body { background:#161616; }
        h1 { color:#fff; }
        .wrapper { margin:2rem 0; }

        .card {
            border:none; overflow:hidden; border-radius:20px; min-height:450px;
            box-shadow:0 0 12px 0 rgba(0,0,0,0.2);
            transition:all 500ms cubic-bezier(0.19,1,0.22,1);
        }
        @@media (max-width:768px){ .card{ min-height:350px; } }
        @@media (max-width:420px){ .card{ min-height:300px; } }

        .card.card-has-bg {
            background-size:120%; background-repeat:no-repeat; background-position:center;
            position:relative;
        }
        .card.card-has-bg:before {
            content:''; position:absolute; inset:0; background:inherit; filter:grayscale(100%);
        }
        .card.card-has-bg:hover {
            transform:scale(0.98); box-shadow:0 0 5px -2px rgba(0,0,0,0.3); background-size:130%;
        }

        .card .card-img-overlay {
            position:relative;
            background:linear-gradient(0deg, rgba(255,186,33,0.38) 0%, rgba(255,186,33,1) 100%);
            transition:all 800ms cubic-bezier(0.19,1,0.22,1);
        }
        .card:hover .card-img-overlay {
            background:linear-gradient(0deg, rgba(255,186,33,0.5) 0%, rgba(255,186,33,1) 100%);
        }

        .card .card-body { transition:all 500ms cubic-bezier(0.19,1,0.22,1); }
        .card:hover .card-body { margin-top:10px; }
        .card .card-title { font-weight:800; }
        .card .card-meta {
            color:rgba(0,0,0,0.55); text-transform:uppercase; font-weight:600; letter-spacing:1px;
        }
        .card .card-footer { background:none; border-top:none; }

        /* Modal 內表格對齊 */
        #participantsTableContainer table td,
        #participantsTableContainer table th { vertical-align:middle; }
    </style>
}

@section Scripts {
<script>
    let currentEventId = 0;

    // 開啟 Modal：從卡片帶 eventId & title，發出 AJAX 取得名單
    document.addEventListener('click', function (e) {
        const card = e.target.closest('.cardDetail');
        if (!card) return;

        currentEventId = parseInt(card.getAttribute('data-event-id')) || 0;
        const title = card.getAttribute('data-event-title') || '參與者名單';

        document.getElementById('participantsModalLabel').textContent = title;
        document.getElementById('modalEventId').textContent = currentEventId;

        // 設定單一活動匯出連結
        const csv = document.getElementById('btnExportCsv');
        const xls = document.getElementById('btnExportExcel');
        csv.setAttribute('href', `/Participants/ExportCsv?eventId=${currentEventId}`);
        xls.setAttribute('href', `/Participants/ExportExcel?eventId=${currentEventId}`);

        loadParticipantsTable(currentEventId);
    });

    // 載入該活動的參與者表格（部分檢視）
    async function loadParticipantsTable(eventId){
        const container = document.getElementById('participantsTableContainer');
        container.innerHTML = `
            <div class="text-center text-muted py-5" id="tableLoading">
                <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                載入中…
            </div>
        `;
        try {
            const res = await fetch(`/Participants/ListByEvent?eventId=${eventId}`, { method:'GET', headers: { 'X-Requested-With': 'XMLHttpRequest' } });
            const html = await res.text();
            container.innerHTML = html;
        } catch(err){
            container.innerHTML = `<div class="alert alert-danger">載入失敗：${err}</div>`;
        }
    }

    // 批次刪除（Modal 內）
    document.getElementById('btnBulkDelete').addEventListener('click', async function () {
        if (!currentEventId) return;

        // 收集已勾選的參與者 id（支援 class=row-check 或 data-id）
        const checks = Array.from(document.querySelectorAll('#participantsTableContainer input[type="checkbox"]'))
            .filter(x => x.checked && (x.dataset.id || x.value));
        const ids = checks.map(x => parseInt(x.dataset.id || x.value)).filter(n => !isNaN(n));

        if (ids.length === 0) {
            alert('請先勾選要刪除的項目。');
            return;
        }

        if (!confirm(`確定刪除 ${ids.length} 筆報名資料嗎？`)) return;

        // 取 CSRF
        const token = document.querySelector('#bulkForm input[name="__RequestVerificationToken"]').value;

        try {
            const form = new FormData();
            form.append('__RequestVerificationToken', token);
            form.append('eventId', currentEventId);
            ids.forEach(id => form.append('ids', id.toString()));

            const res = await fetch('/Participants/BulkDelete', { method:'POST', body: form });
            const json = await res.json();

            if (json.success) {
                await loadParticipantsTable(currentEventId); // 重新載入表格
            } else {
                alert(json.message || '刪除失敗。');
            }
        } catch(err){
            alert('刪除失敗：' + err);
        }
    });
</script>
}
