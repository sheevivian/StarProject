@{
    ViewData["Title"] = "月營收與迴歸分析";
    var productCategories = ViewBag.ProductCategories as List<string>;
}

<style>
    body {
        background: url(https://cdn.pixabay.com/photo/2021/01/17/02/02/planets-5923806_1280.jpg) no-repeat center center fixed;
        background-size: cover;
        color: #fff;
        font-family: 'Segoe UI', sans-serif;
    }

    #notify-marquee {
        color: #000 !important; /* 黑字 */
    }

    h2.section-title {
        text-align: center;
        font-weight: bold;
        margin: 40px 0 20px;
        color: #E0E0FF;
    }

    .filters {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 15px;
        margin-bottom: 30px;
    }

        .filters label {
            margin-right: 5px;
            font-weight: 500;
        }

    .chart-card {
        background: rgba(255,255,255,0.08);
        border-radius: 12px;
        padding: 15px;
        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        margin-bottom: 25px;
    }

    .chart-title {
        text-align: center;
        font-weight: 600;
        color: #FFDDAA;
        margin-bottom: 10px;
        font-size: 1.1rem;
    }

    .chart-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
        gap: 20px;
    }
</style>

<div class="container my-5">

    <!-- 月份選擇: 商品 / 票券雙環圖 -->
    <h2 class="section-title">月營收分析</h2>
    <div class="filters">
        <div>
            <label for="monthSelectRevenue">月份：</label>
            <select id="monthSelectRevenue" class="form-select d-inline-block w-auto"></select>
        </div>
    </div>

    <div class="chart-grid">
        <div class="chart-card">
            <div class="chart-title">商品類別銷售 (當月)</div>
            <div id="productChart" style="width:100%;height:300px;"></div>
        </div>
        <div class="chart-card">
            <div class="chart-title">票券類別銷售 (當月)</div>
            <div id="ticketChart" style="width:100%;height:300px;"></div>
        </div>
    </div>

    <!-- 類別 → 前三名商品 -->
    <h2 class="section-title">商品類別前3名</h2>
    <div class="filters">
        <div>
            <label for="categorySelect">商品類別：</label>
            <select id="categorySelect" class="form-select d-inline-block w-auto">
                <option value="">--請選擇類別--</option>
                @if (productCategories != null)
                {
                    @foreach (var cat in productCategories)
                    {
                        <option value="@cat">@cat</option>
                    }
                }
            </select>
        </div>
    </div>
    <div class="chart-card">
        <div class="chart-title">前3名商品數量</div>
        <div id="topProductsChart" style="width:100%;height:300px;"></div>
    </div>

    <!-- 票券 Type 分析 --> 
    <h2 class="section-title">票券種類銷售數量</h2> 
    <div class="filters">
        <div> <label for="monthSelectTicket">月份：</label> <select id="monthSelectTicket" class="form-select d-inline-block w-auto">

        </select>
        </div> 
        </div>
        <div class="chart-card"> <div class="chart-title">票券種類銷售數量</div> 
        <div id="typeByMonthChart" style="width:100%;height:300px;"></div> 
    </div>


    <!-- 每月總營收折線圖 -->
    <h2 class="section-title">每月總營收折線圖</h2>
    <div class="chart-card">
        <div id="revenueChart" style="width:100%;height:350px;"></div>
    </div>

    <!-- 回歸分析 -->
    <h2 class="section-title">迴歸分析 (折扣 vs 營收)</h2>
    <div class="chart-grid">
        <div class="chart-card">
            <div class="chart-title">商品迴歸分析</div>
            <div id="productRegression" style="width:100%;height:300px;"></div>
        </div>
        <div class="chart-card">
            <div class="chart-title">票券迴歸分析</div>
            <div id="ticketRegression" style="width:100%;height:300px;"></div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    $(function(){
        // 月份選單
        function initMonthSelect(id){
            for(let m=1;m<=12;m++){
                let mm = m<10 ? '0'+m : m;
                $(`#${id}`).append(`<option value="${mm}">${mm}月</option>`);
            }
        }
        initMonthSelect("monthSelectRevenue");
        initMonthSelect("monthSelectTicket");

        // 商品類別前3名圖表
        var topProductsChart = echarts.init(document.getElementById('topProductsChart'));
            $("#categorySelect").change(function(){
        const cat = $(this).val();
        if(!cat) return;
        $.getJSON(`/Analysis/GetTopProductsByCategory?category=${cat}`, function(res){
            topProductsChart.setOption({
                title:{text:`${cat} 類別前三名商品`, left:'center'},
                tooltip:{trigger:'axis'},
                xAxis:{type:'category', data:res.map(x=>x.name)},
                yAxis:{type:'value', name:'數量'},
                series:[{
                    type:'bar',
                    data:res.map(x=>x.value),
                    itemStyle:{color:'#84C1FF'},
                    label:{show:true, position:'top'}
                }]
            });
        });
    });

    // 初始載入時呼叫
    if($("#categorySelect").val()){
        $("#categorySelect").trigger("change");
    }


        // 商品 / 票券雙環圖
        function loadRevenueCharts(year, month){
            // 商品
            $.getJSON(`/Analysis/GetMonthlyProductData?year=${year}&month=${month}`, function(res){
                var productChart = echarts.init(document.getElementById('productChart'));
                res.counts.forEach((item,i)=>item.itemStyle={color:['#003060','#84C1FF','#00CACA','#A6FFFF','#006030','#96FED1','#548C00','#6A6AFF'][i%8]});
                res.revenues.forEach((item,i)=>item.itemStyle={color:['#003060','#84C1FF','#00CACA','#A6FFFF','#006030','#96FED1','#548C00','#6A6AFF'][i%8]});
                productChart.setOption({
                    tooltip:{trigger:'item'},
                    legend:{top:'90%',left:'center'},
                    series:[
                        {name:'營收金額',type:'pie',radius:[0,'40%'],label:{position:'inside'},data:res.revenues},
                        {name:'銷售數量',type:'pie',radius:['55%','70%'],label:{position:'outside'},data:res.counts}
                    ]
                });
            });

            // 票券
            $.getJSON(`/Analysis/GetMonthlyTicketData?year=${year}&month=${month}`, function(res){
                // 過濾 NULL
                res.counts = res.counts.filter(x=>x.name);
                res.revenues = res.revenues.filter(x=>x.name);
                var ticketChart = echarts.init(document.getElementById('ticketChart'));
                res.counts.forEach((item,i)=>item.itemStyle={color:['#4F0202','#984B4B','#6C3365','#B766AD','#9F0050','#FFC1E0','#FFB5B5','#FFE6FF'][i%8]});
                res.revenues.forEach((item,i)=>item.itemStyle={color:['#4F0202','#984B4B','#6C3365','#B766AD','#9F0050','#FFC1E0','#FFB5B5','#FFE6FF'][i%8]});
                ticketChart.setOption({
                    tooltip:{trigger:'item'},
                    legend:{top:'90%',left:'center'},
                    series:[
                        {name:'營收金額',type:'pie',radius:[0,'40%'],label:{position:'inside'},data:res.revenues},
                        {name:'銷售數量',type:'pie',radius:['55%','70%'],label:{position:'outside'},data:res.counts}
                    ]
                });
            });
        }


            // 初始化票券種類圖表
            var typeByMonthChart = echarts.init(document.getElementById('typeByMonthChart'));

            // 監聽月份選單變化
            $("#monthSelectTicket").change(function(){
                const m = $(this).val();
                const y = new Date().getFullYear(); // 你也可以做年份選單
                $.getJSON(`/Analysis/GetTicketTypeCountsByMonth?year=${y}&month=${m}`, function(res){
                    typeByMonthChart.setOption({
                        title: { text: `${y}年${m}月 票券種類銷售數量`, left: 'center' },
                        tooltip: { trigger: 'axis' },
                        xAxis: { type: 'category', data: res.map(x=>x.name) },
                        yAxis: { type: 'value', name: '數量' },
                        series: [{
                            type: 'bar',
                            data: res.map(x=>x.value),
                            itemStyle: { color: '#FFB366' },
                            label: { show: true, position: 'top' }
                        }]
                    });
                });
            });



        // 初次載入
        let currentMonth = $("#monthSelectRevenue").val() || new Date().getMonth()+1;
        currentMonth = currentMonth<10 ? '0'+currentMonth : currentMonth;
        loadRevenueCharts(new Date().getFullYear(), currentMonth);

        $("#monthSelectRevenue").change(function(){
            let m = $(this).val();

            loadRevenueCharts(new Date().getFullYear(), m);
        });
        // $("#monthSelectTicket").change(function(){
        //     let m = $(this).val();
        //     loadRevenueCharts(new Date().getFullYear(), m);
        // });

        // 每月總營收折線圖
        var revenueChart = echarts.init(document.getElementById('revenueChart'));
        fetch('/Analysis/RevenueByMonth')
            .then(res=>res.json())
            .then(data=>{
                let years = [...new Set(data.map(d=>d.year))].sort();
                let months = [1,2,3,4,5,6,7,8,9,10,11,12];
                let categories = [...new Set(data.map(d=>d.category))];
                let latestYear = years[years.length-1];
                let series = categories.map(cat=>({
                    name:cat,
                    type:'line',
                    data:months.map(m=>{
                        let item = data.find(d=>d.year==latestYear && d.month==m && d.category==cat);
                        return item ? item.revenue : 0;
                    })
                }));
                revenueChart.setOption({
                    title:{text:'各分類每月營收折線圖（'+latestYear+'）'},
                    tooltip:{trigger:'axis'},
                    legend:{data:categories},
                    xAxis:{type:'category',data:months.map(m=>m+'月')},
                    yAxis:{type:'value',name:'營收'},
                    series:series
                });
            });

        // 回歸圖
        function fetchRegression(type, id, title){
            fetch(`/Analysis/GetDiscountRevenueData?type=${type}`)
            .then(r=>r.json())
            .then(data=>{
                let chart = echarts.init(document.getElementById(id));
                let points = data.map(d=>[d.discount,d.revenue]);
                let n = points.length;
                let sumX = points.reduce((a,b)=>a+b[0],0);
                let sumY = points.reduce((a,b)=>a+b[1],0);
                let sumXY = points.reduce((a,b)=>a+b[0]*b[1],0);
                let sumX2 = points.reduce((a,b)=>a+b[0]*b[0],0);
                let slope = (n*sumXY - sumX*sumY)/(n*sumX2 - sumX*sumX);
                let intercept = (sumY - slope*sumX)/n;
                let minX = Math.min(...points.map(p=>p[0]));
                let maxX = Math.max(...points.map(p=>p[0]));
                let regressionLine = [[minX, slope*minX+intercept],[maxX, slope*maxX+intercept]];
                chart.setOption({
                    title:{text:title,left:'center'},
                    tooltip:{trigger:'axis',axisPointer:{type:'cross'}},
                    xAxis:{name:'折扣'},
                    yAxis:{name:'營收'},
                    series:[
                        {name:'數據點',type:'scatter',data:points},
                        {name:'回歸線',type:'line',data:regressionLine,smooth:true,lineStyle:{color:'red'}}
                    ]
                });
            });
        }
        fetchRegression("Product","productRegression","商品回歸分析");
        fetchRegression("Ticket","ticketRegression","票券回歸分析");

    });
</script> 
 



