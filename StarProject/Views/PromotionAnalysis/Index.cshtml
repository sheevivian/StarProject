@using StarProject.DTOs.PromotionDTOs
@model IEnumerable<PromotionAnalysisDto> // ✅ 修正：型別與 Controller.Index 一致

@{
    ViewData["Title"] = "優惠券成效分析";
}

<head>
    <link href="~/css/promotion.css" rel="stylesheet" />
</head>

<main class="flex-fill position-relative">
    <div class="d-flex align-items-center mb-3">
        <h1 class="fw-bold flex-grow-1 mb-0">優惠券成效分析</h1>
    </div>

    <!-- 搜尋 + 每頁筆數 -->
    <div class="input-group input-group-lg">
        <input id="searchInput" type="text" class="form-control" placeholder="請輸入優惠名稱或類別">
        <button type="button" class="input-group-text search" id="btnSearch">
            <i class="fa-solid fa-magnifying-glass"></i>
        </button>

        <div class="d-flex gap-3">
            <div style="width:150px">
                <select class="form-select form-select-lg" id="pageSizeSelect" onchange="loadData(1)">
                    <option selected value="10">每頁10筆</option>
                    <option value="15">每頁15筆</option>
                    <option value="20">每頁20筆</option>
                    <option value="25">每頁25筆</option>
                </select>
            </div>
        </div>
    </div>

    <div class="table-rounded position-relative mt-3">
        <table class="table table-hover table-borderless">
            <thead>
                <tr>
                    <th>編號</th>
                    <th>名稱</th>
                    <th>分類</th>
                    <th>狀態</th>
                    <th>開始日期</th>
                    <th>結束日期</th>
                    <th>限定次數</th>
                    <th>實際使用</th>
                    <th>使用人數</th>
                    <th>使用率 (%)</th>
                </tr>
            </thead>
            <tbody id="tableBody"><!-- ✅ 首屏不渲染，由 JS 載入 --></tbody>
        </table>

        <!-- ✅ 修改：與 Shared/_Pagination 匹配的容器 -->
        <div id="paginationContainer" class="mt-3"></div>
    </div>
</main>

@section Scripts {
    <script>
        async function loadData(page) {
            const pageSize = document.getElementById("pageSizeSelect").value;
            const search = document.getElementById("searchInput").value;

            const qs = new URLSearchParams({ page, pageSize, search });
            const res = await fetch(`/PromotionAnalysis/GetPagedData?${qs.toString()}`);
            if (!res.ok) {
                console.error("Fetch failed", res.status);
                return;
            }
            const result = await res.json();

            document.getElementById("tableBody").innerHTML = result.rows;
            document.getElementById("paginationContainer").innerHTML = result.pagination; // ✅ 由 partial 輸出填入
        }

        // ✅ 修改：Shared/_Pagination.cshtml 內用的是 refreshTable(page)
        function refreshTable(page) {
            loadData(page);
        }

        document.getElementById("btnSearch").addEventListener("click", () => loadData(1));
        document.addEventListener("DOMContentLoaded", () => loadData(1));
    </script>
}