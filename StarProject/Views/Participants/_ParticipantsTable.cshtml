@using Microsoft.AspNetCore.Html
@model IEnumerable<StarProject.Models.Participant>
@Html.AntiForgeryToken()  <!-- ✅ 加這行，供前端抓 Token -->

<style>
    .table > thead > tr > th {
        font-size: 18px !important;
        color: #FFFFFF;
        background-color: #2B4C8C;
        letter-spacing: .2rem;
    }

    .table > tbody > tr.active > td {
        background-color: rgba(223,245,255,.521) !important;
    }

    .table > tbody > tr > td {
        border-color: #D5D8DB !important;
    }

    .table tbody tr:hover td {
        background-color: #F4F1FF !important;
    }

    .table-rounded {
        border-radius: 10px;
        overflow: hidden;
    }

    .table {
        border-collapse: separate !important;
        border-spacing: 0;
        border-radius: 20px;
        overflow: hidden;
        vertical-align: middle;
    }

    .btn-group .btn {
        border-radius: 0;
    }

    .btn-group .btn:first-child {
        border-radius: 0.375rem 0 0 0.375rem;
    }

    .btn-group .btn:last-child {
        border-radius: 0 0.375rem 0.375rem 0;
    }

    .table-responsive {
        border-radius: 0.5rem;
        overflow: hidden;
        border: 1px solid #dee2e6;
    }

    .status-chip {
        display: inline-flex;
        align-items: center;
        gap: .4rem;
        padding: .15rem .5rem;
        font-size: .875rem;
        line-height: 1.1;
        border: 1px solid currentColor;
        border-radius: 2px; /* 非膠囊，方角 */
        background: transparent; /* 透明底 */
        font-weight: 600;
        white-space: nowrap;
    }

    .status-chip .dot {
        width: .5rem;
        height: .5rem;
        border-radius: 50%;
        background: currentColor;
        opacity: .85;
        display: inline-block;
    }

    .status-success {
        color: #198754;
    }
    /* Bootstrap success 綠 */
    .status-pending {
        color: #6c757d;
    }
    /* 次要灰 */
    .status-cancel {
        color: #dc3545;
    }
    /* Bootstrap danger 紅 */

    /* 去除所有直向邊線（欄位分隔線） */
    .table > :not(caption) > * > * {
        border-left-width: 0 !important;
        border-right-width: 0 !important;
    }

    /* 只保留水平底線（可自行調淡或拿掉） */
    .table thead th,
    .table tbody td {
        border-bottom: 1px solid rgba(0,0,0,.08); /* 想再淡一點就改 .05 */
    }

    /* 表頭不要上邊線 */
    .table thead th {
        border-top: 0 !important;
    }

    /* 只拿掉 table 本身的外框線，外層 .table-responsive 的邊框保留 */
    #participantsTableContainer .table {
        border: 0 !important; /* 防止出現整圈外框 */
        border-radius: 0 !important;
        overflow: visible !important;
    }

    /* 邊緣那一圈線也一併消失（保留列與列之間的水平分隔線） */
    #participantsTableContainer .table > :not(caption) > * > * {
        border-left-width: 0 !important;
        border-right-width: 0 !important;
    }

    /* 表頭不要上邊線（避免上緣再畫一條） */
    #participantsTableContainer thead th {
        border-top: 0 !important;
    }

    /* 最後一列不要底線，避免和外框的下邊線疊成雙線 */
    #participantsTableContainer tbody tr:last-child td {
        border-bottom: 0 !important;
    }

    /* 保留一般列與列之間的水平分隔線（若你想要） */
    #participantsTableContainer tbody td {
        border-bottom: 1px solid rgba(0,0,0,.08);
    }


</style>

@{
    int eventId = ViewBag.EventId ?? 0;
    bool hasRows = Model != null && Model.Any();

    Func<string?, IHtmlContent> statusChip = (s) =>
    {
        string label, cls;
        switch (s)
        {
            case "Success":
            case "報名成功":
                label = "報名成功"; cls = "status-success"; break;
            case "Pending":
                label = "待處理"; cls = "status-pending"; break;
            case "Canceled":
            case "Cancelled":
                label = "報名取消已退款"; cls = "status-cancel"; break;
            default:
                label = s ?? "未知狀態"; cls = "status-pending"; break;
        }

        // 為避免萬一 label 含特殊字元，先做 HTML encode
        var safeLabel = System.Net.WebUtility.HtmlEncode(label);

        var html = $"<span class=\"status-chip {cls}\">" +
                   $"<i class=\"dot\"></i><span>{safeLabel}</span>" +
                   $"</span>";

        return new HtmlString(html);
    };
}

<!-- 批次刪除用的隱藏表單 -->
<form id="bulkForm" style="display:none;">
    @Html.AntiForgeryToken()
</form>

<!-- 批次操作工具列 -->
<div class="d-flex align-items-center justify-content-between mb-3">
    <div class="d-flex align-items-center gap-2">
        <button type="button" id="btnBulkDelete" class="btn btn-sm btn-outline-danger">
            <i class="bi bi-trash"></i> 多筆刪除
        </button>
        <small class="text-muted">請先勾選要操作的項目</small>
    </div>
    <div class="text-muted small">
        共 @(Model?.Count() ?? 0) 筆資料
    </div>
</div>

<div class="table-responsive">
    <table class="table table-hover align-middle mb-0">
        <thead class="table-light text-center">
            <tr>
                <th style="width:60px ">
                    <input type="checkbox" id="checkAll" data-check-all />
                </th>
                <th style="width:160px">報名日期</th>
                <th style="width:160px">最後更新</th>
                <th>會員姓名</th>
                <th style="width:160px">狀態</th>
                <th style="width:220px">操作</th>
            </tr>
        </thead>
        <tbody class="text-center">
            @if (!hasRows)
            {
                <tr>
                    <td colspan="6" class="text-center text-muted py-4">
                        <i class="bi bi-inbox fs-1 d-block mb-2 opacity-50"></i>
                        尚無報名紀錄
                    </td>
                </tr>
            }
            else
            {
                @foreach (var p in Model)
                {
                    <tr data-id="@p.No">
                        <td>
                            <input type="checkbox"
                                   class="row-check"
                                   name="ids"
                                   value="@p.No"
                                   data-id="@p.No" />
                        </td>
                        <td>
                            <div class="small">
                                <div>@p.RegisteredDate.ToString("yyyy-MM-dd")</div>
                                <div class="text-muted">@p.RegisteredDate.ToString("HH:mm")</div>
                            </div>
                        </td>
                        <td>
                            <div class="small">
                                <div>@p.UpdatedAt.ToString("yyyy-MM-dd")</div>
                                <div class="text-muted">@p.UpdatedAt.ToString("HH:mm")</div>
                            </div>
                        </td>
                        <td>
                            <div class="fw-medium">@(p.UsersNoNavigation?.Name ?? "未知會員")</div>
                            @if (!string.IsNullOrEmpty(p.UsersNoNavigation?.Email))
                            {
                                <div class="small text-muted">@p.UsersNoNavigation.Email</div>
                            }
                        </td>
                        <td>@statusChip(p.Status)</td>
                        <td>
                            <button type="button"
                                    class="btn btn-outline-primary btn-sm me-1 js-resend"
                                    data-id="@p.No"
                                    title="重寄報名確認信">
                                <i class="bi bi-arrow-repeat me-1"></i> 重寄確認信
                            </button>

                            <button type="button"
                                    class="btn btn-outline-danger btn-sm js-row-delete"
                                    data-id="@p.No"
                                    title="刪除這筆報名">
                                <i class="bi bi-trash3 me-1"></i> 刪除
                            </button>
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
</div>

