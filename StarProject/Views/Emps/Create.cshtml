@model StarProject.ViewModels.CreateEmpViewModel
@using StarProject.Helpers

@{
    ViewData["Title"] = "新增員工";
}

<style>
    .card-header {
        background-color: #2B4C8C !important;
        color: #fff !important;
    }
    .card-header * {
        color: inherit;
    }
</style>

<h1 class="fw-bold">新增員工</h1>
<hr />

<div class="row">
    <div class="d-flex">
        <form asp-action="Create" method="post" id="empForm" class="w-100">
            <div class="row g-4">
                <!-- 左欄：基本資料 -->
                <div class="col-lg-6">
                    <div class="card h-100">
                        <div class="card-header"><strong>基本資料</strong></div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="control-label fw-bold fs-6">員工編號</label>
                                <input type="text" class="form-control" value="系統自動編號無須輸入" disabled
                                       style="background-color:#e9ecef;cursor:not-allowed;" />
                            </div>

                            <div class="mb-3">
                                <label asp-for="Name" class="control-label fw-bold fs-6">姓名 <span class="text-danger">*</span></label>
                                <input asp-for="Name" class="form-control" placeholder="請輸入員工姓名" />
                                <span asp-validation-for="Name" class="text-danger"></span>
                            </div>

                            <div class="mb-3">
                                <label asp-for="Email" class="control-label fw-bold fs-6">Email</label>
                                <input asp-for="Email" type="email" class="form-control" placeholder="example@company.com" />
                                <span asp-validation-for="Email" class="text-danger"></span>
                            </div>

                            <div class="mb-3">
                                <label asp-for="Phone" class="control-label fw-bold fs-6">電話</label>
                                <input asp-for="Phone" class="form-control" placeholder="請輸入聯絡電話" />
                                <span asp-validation-for="Phone" class="text-danger"></span>
                            </div>

                            <div class="mb-3">
                                <label asp-for="DeptNo" class="control-label fw-bold fs-6">部門 <span class="text-danger">*</span></label>
                                <select asp-for="DeptNo" class="form-select" asp-items="@Model.Depts">
                                    <option value="">請選擇部門</option>
                                </select>
                                <span asp-validation-for="DeptNo" class="text-danger"></span>
                            </div>

                            <div class="mb-3">
                                <label asp-for="RoleNo" class="control-label fw-bold fs-6">職位 <span class="text-danger">*</span></label>
                                <select asp-for="RoleNo" class="form-select">
                                    <option value="">請選擇職位</option>
                                    @if (Model.Roles != null)
                                    {
                                        @foreach (var role in Model.Roles)
                                        {
                                            var isSelected = Model.RoleNo.ToString() == role.Value ? "selected" : "";
                                            <option value="@role.Value" @@isSelected>
                                                @RoleHelper.GetRoleDisplayName(role.Text)
                                            </option>
                                        }
                                    }
                                </select>
                                <span asp-validation-for="RoleNo" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6 d-flex flex-column h-100">
                    <!-- 個人資料 -->
                    <div class="card flex-fill mb-3">
                        <div class="card-header"><strong>個人資料</strong></div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label asp-for="IdNumber" class="control-label fw-bold fs-6">身分證字號</label>
                                <input asp-for="IdNumber" class="form-control" placeholder="請輸入身分證字號" maxlength="10" />
                                <span asp-validation-for="IdNumber" class="text-danger"></span>
                            </div>
                            <div class="mb-3">
                                <label asp-for="BirthDate" class="control-label fw-bold fs-6">生日</label>
                                <input asp-for="BirthDate" type="date" class="form-control" />
                                <span asp-validation-for="BirthDate" class="text-danger"></span>
                            </div>
                        </div>
                    </div>

                    <!-- 到職資訊 -->
                    <div class="card flex-fill">
                        <div class="card-header"><strong>到職資訊</strong></div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label asp-for="HireDate" class="control-label fw-bold fs-6">到職日期 <span class="text-danger">*</span></label>
                                <input asp-for="HireDate" type="date" class="form-control" />
                                <span asp-validation-for="HireDate" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="form-group d-flex gap-2 mt-2 justify-content-center">
                <button type="submit" class="btn btn-warning fw-bold fs-5 text-distance" style="width:303px"
                        onclick="return validateAndSubmit()">
                    <i class="fa-solid fa-plus"></i> 新增
                </button>
                <a asp-action="Index" class="btn btn-outline-danger fw-bold fs-5" style="width:303px">
                    返回列表
                </a>
            </div>

        </form>
    </div>
</div>

<!-- 成功訊息 -->
@if (TempData["NewEmpCode"] != null)
{
    <div class="alert alert-success alert-dismissible fade show mt-3">
        <strong>新員工建立成功！</strong><br>
        <strong>員工編號：</strong>@TempData["NewEmpCode"]<br>
        <strong>預設密碼：</strong>@TempData["TempPassword"]
        @if (TempData["EmailSent"] != null)
        {
            <br>
            <span class="text-success">登入通知已成功發送至員工信箱</span>
        }
        <button type="button" class="close" data-dismiss="alert">
            <span>&times;</span>
        </button>
    </div>
}

@if (TempData["EmailError"] != null)
{
    <div class="alert alert-warning alert-dismissible fade show mt-3">
        @TempData["EmailError"]
        <button type="button" class="close" data-dismiss="alert">
            <span>&times;</span>
        </button>
    </div>
}

@section Scripts {
    <script>
        // 設置今天為預設到職日期
        document.addEventListener('DOMContentLoaded', function() {
            var hireDateInput = document.querySelector('input[name="HireDate"]');
            if (hireDateInput && !hireDateInput.value) {
                var today = new Date().toISOString().split('T')[0];
                hireDateInput.value = today;
            }

            // Debug: 檢查下拉選單是否正確載入
            console.log('部門選項數量:', document.querySelector('select[name="DeptNo"]').options.length);
            console.log('職位選項數量:', document.querySelector('select[name="RoleNo"]').options.length);
        });

        function validateAndSubmit() {
            var form = document.getElementById('empForm');
            var name = document.querySelector('input[name="Name"]').value.trim();
            var deptNo = document.querySelector('select[name="DeptNo"]').value;
            var roleNo = document.querySelector('select[name="RoleNo"]').value;
            var hireDate = document.querySelector('input[name="HireDate"]').value;

            console.log('表單驗證開始...');
            console.log('姓名:', name);
            console.log('部門編號:', deptNo);
            console.log('職位編號:', roleNo);
            console.log('到職日:', hireDate);

            var errors = [];

            if (!name) errors.push('請填寫姓名');
            if (!deptNo) errors.push('請選擇部門');
            if (!roleNo) errors.push('請選擇職位');
            if (!hireDate) errors.push('請選擇到職日期');

            if (errors.length > 0) {
                alert('請修正以下問題：\n' + errors.join('\n'));
                return false;
            }

            console.log('表單驗證通過，準備提交...');
            return true;
        }

        // 監聽表單提交事件
        document.getElementById('empForm').addEventListener('submit', function(e) {
            console.log('表單提交事件觸發');
            console.log('Action:', this.action);
            console.log('Method:', this.method);
            
            // Debug: 輸出所有表單數據
            var formData = new FormData(this);
            for (var pair of formData.entries()) {
                console.log(pair[0] + ': ' + pair[1]);
            }
        });
    </script>

    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
}