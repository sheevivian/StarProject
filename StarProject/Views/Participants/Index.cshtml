@model StarProject.ViewModels.ParticipantsIndexVm
@using StarProject.ViewModels

@{
    ViewData["Title"] = "報名管理";
    var cards = Model?.Cards ?? new List<EventCardVm>();
}

<!-- 標題 & 匯出「全部」 -->
<div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="fw-bold text-white">報名管理</h1>
    <div class="d-flex gap-2">
        <a class="btn btn-outline-light" asp-controller="Participants" asp-action="ExportExcel">匯出全部 Excel</a>
        <a class="btn btn-outline-light" asp-controller="Participants" asp-action="ExportCsv">匯出全部 CSV</a>
    </div>
</div>

<hr />

<!-- 卡片網格-->
<!-- 卡片網格-->
<section class="wrapper">
    <div class="container">
        <!-- 一行四張：lg 以上 4 欄；md 2 欄；xs 1 欄 -->
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4" id="eventCardGrid">
            @if (!cards.Any())
            {
                <div class="col-12">
                    <div class="alert alert-warning">目前沒有可顯示的活動。</div>
                </div>
            }
            else
            {
                @foreach (var e in cards)
                {
                    // 背景圖處理（沿用你的邏輯）
                    var raw = e.CoverImageUrl ?? "";
                    string bg;
                    if (string.IsNullOrWhiteSpace(raw))
                    {
                        bg = "https://images.unsplash.com/photo-1444703686981-a3abbc4d4fe3?q=80&w=1400&auto=format&fit=crop";
                    }
                    else if (raw.StartsWith("http", StringComparison.OrdinalIgnoreCase))
                    {
                        bg = raw;
                    }
                    else
                    {
                        var normalized = (raw.StartsWith("~/") || raw.StartsWith("/")) ? raw : $"~/uploads/{raw}";
                        bg = Url.Content(normalized);
                    }

                    // 狀態角標樣式：報名中=黃、已結束=灰、已取消=紅（可依實際字串調整）
                    var status = (e.Status ?? "").Trim();
                    string badgeClass = status switch
                    {
                        "報名中" => "bg-warning text-dark",
                        "已結束" => "bg-secondary",
                        "已取消" => "bg-danger",
                        _ => "bg-secondary"
                    };

                    <div class="col">
                        <div class="card h-100 event-card position-relative shadow-sm cardDetail"
                             data-event-id="@e.No"
                             data-event-title="@e.Title"
                             data-bs-toggle="modal"
                             data-bs-target="#participantsModal"
                             role="button"
                             aria-label="檢視 @e.Title 的報名名單">

                            <!-- 狀態角標 -->
                            <span class="badge position-absolute top-0 start-0 m-2 px-2 py-1 @badgeClass"
                                  style="z-index:2; border-radius:.5rem;">
                                @status
                            </span>

                            <!-- 上：固定比例的封面（16:9），圖片一致裁切 -->
                            <div class="card-thumb" style="background-image:url('@bg');" aria-label="@e.Title"></div>

                            <!-- 下：只保留 標題 / 時間 / 人數 -->
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title fw-bold text-truncate mb-2" title="@e.Title">@e.Title</h5>

                                <div class="d-flex align-items-center gap-2 text-muted mb-1">
                                    <i class="far fa-clock"></i>
                                    <small>@e.StartDate.ToString("yyyy/MM/dd HH:mm")</small>
                                </div>

                                <div class="d-flex align-items-center gap-2 text-muted">
                                    <i class="bi bi-people"></i>
                                    <small>@e.CurrentCount / @e.MaxParticipants 人</small>
                                </div>

                                <!-- 點整張卡片可開啟名單 Modal -->
                                <a class="stretched-link" href="javascript:void(0)"></a>
                            </div>
                        </div>
                    </div>
                }
            }
        </div>
    </div>
</section>


<!-- Modal：顯示單一活動的參與者名單 -->
<div class="modal fade" id="participantsModal" tabindex="-1" aria-labelledby="participantsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h4 class="modal-title fw-bold mb-1" id="participantsModalLabel">參與者名單</h4>
                    <div class="small text-muted" id="participantsModalSub">活動編號：<span id="modalEventId">-</span></div>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="關閉"></button>
            </div>

            <div class="modal-body">
                <!-- 工具列：單一活動匯出、批次刪除 -->
                <div class="d-flex align-items-center gap-2 mb-3">
                    <a class="btn btn-outline-primary" id="btnExportCsv" target="_blank" rel="noopener">
                        <i class="fa-solid fa-file-csv me-1"></i> 匯出 CSV（本活動）
                    </a>
                    <a class="btn btn-outline-success" id="btnExportExcel" target="_blank" rel="noopener">
                        <i class="fa-solid fa-file-excel me-1"></i> 匯出 Excel（本活動）
                    </a>

                    <form id="bulkForm" class="ms-auto">
                        @Html.AntiForgeryToken()
                        <button type="button" class="btn btn-outline-danger" id="btnBulkDelete">
                            <i class="fa-solid fa-trash-can me-1"></i> 刪除已勾選
                        </button>
                    </form>
                </div>

                <!-- 名單容器（AJAX 載入 _ParticipantsTable 部分檢視） -->
                <div id="participantsTableContainer" class="border rounded p-2 position-relative" style="min-height:180px">
                    <div class="text-center text-muted py-5" id="tableLoading">
                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                        載入中…
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 樣式 -->
@section Styles {
    <style>
        body {
            background: #161616;
        }

        h1 {
            color: #fff;
        }

        .wrapper {
            margin: 2rem 0;
        }

        /* 視覺層次：白底卡片＋陰影 */
        .event-card {
            border: none;
            border-radius: 16px;
            overflow: hidden;
            background: #fff;
            transition: transform .25s ease, box-shadow .25s ease;
            position: relative; /* 建立堆疊脈絡，角標可定位 */
        }

            .event-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 8px 24px rgba(0,0,0,.18);
            }

        /* 上半：固定比例縮圖 (16:9) + cover，確保整齊 */
        .card-thumb {
            aspect-ratio: 16/9;
            width: 100%;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        /* 下半：內容層次清楚、左對齊 */
        .card-body {
            padding: 14px 16px 16px 16px;
        }

        .card-title {
            line-height: 1.25;
        }

        /* 角標一定浮在最上、而且不擋點擊 */
        .event-card .stretched-link::after {
            z-index: 1;
        }
        /* Bootstrap 預設是 0，明確壓在底層 */
        .event-card .badge {
            z-index: 3;
            pointer-events: none;
        }
        /* 角標永遠在最上，且不吃點擊 */

        /* RWD 高度微調（四欄時仍清爽） */
        @@media (min-width:992px) {
            .event-card {
                min-height: 320px;
            }
        }

        @@media (max-width:991.98px) {
            .event-card {
                min-height: 300px;
            }
        }

        /* 角標字重，易讀 */
        .badge {
            font-weight: 700;
            letter-spacing: .3px;
        }

        /* Modal 內表格對齊（保留） */
        #participantsTableContainer table td,
        #participantsTableContainer table th {
            vertical-align: middle;
        }
    </style>
}



@section Scripts {
    <script>
        let currentEventId = 0;

        // 開啟 Modal：支援點整張卡片（.cardDetail）或覆蓋連結（a.stretched-link）
        document.addEventListener('click', function (e) {
            const trigger = e.target.closest('.cardDetail, a.stretched-link');
            if (!trigger) return;

            const card = trigger.classList.contains('cardDetail') ? trigger : trigger.closest('.cardDetail');
            if (!card) return;

            currentEventId = Number(card.getAttribute('data-event-id')) || 0;
            const title = card.getAttribute('data-event-title') || '參與者名單';

            document.getElementById('participantsModalLabel').textContent = title;
            document.getElementById('modalEventId').textContent = currentEventId;

            // 設定單一活動匯出連結
            const csv = document.getElementById('btnExportCsv');
            const xls = document.getElementById('btnExportExcel');
            csv.setAttribute('href', `/Participants/ExportCsv?eventId=${currentEventId}`);
            xls.setAttribute('href', `/Participants/ExportExcel?eventId=${currentEventId}`);

            loadParticipantsTable(currentEventId);
        });

        // 載入該活動的參與者表格（部分檢視）
        async function loadParticipantsTable(eventId){
            const container = document.getElementById('participantsTableContainer');
            container.innerHTML = `
                <div class="text-center text-muted py-5" id="tableLoading">
                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                    載入中…
                </div>
            `;

            try {
                const res = await fetch(`/Participants/ListByEvent?eventId=${encodeURIComponent(eventId)}`, {
                    method:'GET',
                    headers:{ 'X-Requested-With':'XMLHttpRequest' },
                    cache:'no-store'
                });
                if(!res.ok) throw new Error('HTTP ' + res.status);
                const html = await res.text();
                container.innerHTML = html;
            } catch(err){
                container.innerHTML = `<div class="alert alert-danger">載入失敗：${err.message || err}</div>`;
            }
        }

        // 批次刪除（Modal 內）
        document.getElementById('btnBulkDelete').addEventListener('click', async function () {
            if (!currentEventId) return;

            const checks = Array.from(document.querySelectorAll('#participantsTableContainer input[type="checkbox"]'))
                .filter(x => x.checked && (x.dataset.id || x.value));
            const ids = checks.map(x => parseInt(x.dataset.id || x.value)).filter(n => !isNaN(n));

            if (ids.length === 0) { alert('請先勾選要刪除的項目。'); return; }
            if (!confirm(`確定刪除 ${ids.length} 筆報名資料嗎？`)) return;

            const token = document.querySelector('#bulkForm input[name="__RequestVerificationToken"]').value;

            try {
                const form = new FormData();
                form.append('__RequestVerificationToken', token);
                form.append('eventId', currentEventId);
                ids.forEach(id => form.append('ids', id.toString()));

                const res = await fetch('/Participants/BulkDelete', { method:'POST', body: form });
                const json = await res.json();

                if (json.success) {
                    await loadParticipantsTable(currentEventId);
                } else {
                    alert(json.message || '刪除失敗。');
                }
            } catch(err){
                alert('刪除失敗：' + err);
            }
        });
    </script>
}

