@using StarProject.ViewModels
@model StarMapVM

@{
    ViewData["Title"] = "景點新增";
}

<head>
    <style>
        

        .btn-topbar {
            --bs-btn-bg: rgb(250, 208, 72);
            --bs-btn-border-color: rgb(250, 208, 72);
            --bs-btn-hover-bg: rgba(250, 208, 72, 0.692);
            --bs-btn-hover-border-color: rgba(250, 208, 72, 0.692);
            --bs-btn-focus-shadow-rgb: 217, 164, 6;
            --bs-btn-active-bg: #ffcd39;
            --bs-btn-active-border-color: #ffc720;
            --bs-btn-active-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
        }

        .btn-outline-back {
            --bs-btn-color: #DC3545;
            --bs-btn-border-color: #DC3545;
            --bs-btn-hover-color: #DC3545;
            --bs-btn-hover-bg: #f8e6e9;
            --bs-btn-hover-border-color: #DC3545;
            --bs-btn-focus-shadow-rgb: 255, 193, 7;
            --bs-btn-active-color: #DC3545;
            --bs-btn-active-border-color: #DC3545;
            --bs-btn-active-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
            --bs-gradient: none;
        }

        .card-header {
            background-color: #2B4C8C;
            color: #FFFFFF
        }
    </style>
</head>

<div class="position-relative">
    <h1 class="fw-bold">觀星景點新增</h1>
    <hr />

    <div class="row">
        <form asp-action="Create" style="width:100%" method="post" enctype="multipart/form-data">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <div class="row g-3">
                <!-- 左側：基本資訊 + 圖片 -->
                <div class="col-lg-6 d-flex flex-column gap-3">
                    <div class="card">
                        <div class="card-header fw-bold fs-4"><strong>觀星景點資訊</strong></div>
                        <div class="card-body">
                            <div class="form-group mb-2">
                                <label asp-for="Name" class="control-label fw-bold fs-5"></label>
                                <span asp-validation-for="Name" class="text-danger ms-3"></span>
                                <input asp-for="Name" class="form-control" id="inputName" />
                            </div>
                            <div class="form-group mb-2">
                                <label asp-for="Desc" class="control-label fw-bold fs-5"></label>
                                <span asp-validation-for="Desc" class="text-danger ms-3"></span>
                                <textarea asp-for="Desc" class="form-control" rows="10" placeholder="輸入景點描述..." style="resize: none;" id="inputDesc"></textarea>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header fw-bold fs-4"><strong>圖片上傳</strong></div>
                        <div class="card-body">
                            <div class="form-group mb-2">
                                <div class="input-group">
                                    <input asp-for="ImageFile" class="form-control" type="file" id="ImageFile" />
                                    <button type="button" class="btn btn-outline-secondary" style="width:100px" id="btnPreviewImage">預覽</button>
                                </div>
                                <span asp-validation-for="ImageFile" class="text-danger ms-3"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 圖片預覽小視窗（Bootstrap 5 Modal） -->
                <div class="modal fade" id="imagePreviewModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h4 class="modal-title fw-bold">圖片預覽</h4>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="關閉"></button>
                            </div>
                            <div class="modal-body text-center">
                                <img id="previewImg" alt="圖片預覽" class="img-fluid rounded border">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 右側：地圖 -->
                <div class="col-lg-6">
                    <div class="card h-100">
                        <div class="card-header fw-bold fs-4"><strong>景點位置</strong></div>
                        <div class="card-body d-flex flex-column">
                            <div class="form-group mb-2">
                                <label asp-for="Address" class="control-label fw-bold fs-5"></label>
                                <span asp-validation-for="Address" class="text-danger ms-3"></span>
                                <input asp-for="Address" class="form-control" id="addressInput" placeholder="輸入地址..." />
                                <input type="hidden" asp-for="MapLatitude" id="latitude" />
                                <input type="hidden" asp-for="MapLongitude" id="longitude" />
                            </div>
                            <!-- 地圖固定高度 -->
                            <div id="map" style="flex:1; min-height:400px;" class="rounded border"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group d-flex gap-3 mt-3 text-distance justify-content-center">
                <button type="submit" class="btn btn-topbar fw-bold fs-5 text-distance" style="width:303px">
                    <i class="fa-solid fa-plus"></i>新增
                </button>
                <a asp-action="Index" class="btn btn-outline-back fw-bold fs-5" style="width:303px">返回列表</a>
            </div>
        </form>
    </div>

    <div class="position-absolute top-0 end-0 m-2 me-4">
        <button type="button" id="fillTestData" class="btn btn-light fw-bold fs-6 d-flex justify-content-center align-items-center"
                style="width:40px; height:40px; border-radius:50%; border: 1px solid #D0CBCB;">
            <i class="fa-solid fa-wand-sparkles"></i>
        </button>
    </div>
</div>





@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}

    <script>
        $("#fillTestData").on("click", function() {
                $("#inputName").val("臺灣_阿里山對高岳車站");
                $('#inputDesc').val("位於阿里山鐵道祝山線上的「對高岳車站」，其附近的「對高岳觀日坪」相信是大家不陌生的觀日絕佳景點，每年的元旦「阿里山日出印象音樂會」也都是在這邊舉行。到了晚上不妨回到車站站在鐵軌往上看，天氣好的時候一整片無光害的阿里山銀河就在眼前，配上弧形的車站木造建築，實在是美得像一幅畫。");
                $('#addressInput').val("南投縣信義鄉神木村神木巷47號");
        })
        let map, marker, autocomplete, selectedLatLng;

        function initMap() {
            // 初始化地圖
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 24.985179749943747, lng: 121.22179620690764 }, // 預設聖德基督學院
                zoom: 15,
            });

            marker = new google.maps.Marker({
                map: map,
            });

            // Autocomplete
            const input = document.getElementById("addressInput");
            autocomplete = new google.maps.places.Autocomplete(input);
            autocomplete.bindTo("bounds", map);

            autocomplete.addListener("place_changed", () => {
                const place = autocomplete.getPlace();
                if (!place.geometry) return alert("找不到地點");

                // 地圖移動到該地點
                map.setCenter(place.geometry.location);
                map.setZoom(17);

                // 標記點
                marker.setPosition(place.geometry.location);
                marker.setVisible(true);

                // 更新欄位
                document.getElementById("latitude").value = place.geometry.location.lat();
                document.getElementById("longitude").value = place.geometry.location.lng();
                document.getElementById("addressInput").value = place.formatted_address;
            });
        }

        // ====== 圖片預覽小視窗 ======
          const fileInput = document.getElementById('ImageFile');
          const previewBtn = document.getElementById('btnPreviewImage');
          const previewImg = document.getElementById('previewImg');
          const modalEl    = document.getElementById('imagePreviewModal');
          let previewURL = null;

          function showPreviewModal(file) {
            if (!file) { alert('請先選擇圖片'); return; }
            // 僅接受圖片
            if (!file.type.startsWith('image/')) { alert('請選擇圖片檔'); return; }

            if (previewURL) URL.revokeObjectURL(previewURL);
            previewURL = URL.createObjectURL(file);
            previewImg.src = previewURL;

            const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
            modal.show();
          }

          // 選檔後自動預覽
          fileInput?.addEventListener('change', () => {
            const file = fileInput.files?.[0];
            if (file) showPreviewModal(file);
          });

          // 點「預覽」按鈕（可重看）
          previewBtn?.addEventListener('click', () => {
            const file = fileInput?.files?.[0];
            showPreviewModal(file);
          });

          // 關閉時釋放 URL（避免記憶體增加）
          modalEl?.addEventListener('hidden.bs.modal', () => {
            if (previewURL) {
              URL.revokeObjectURL(previewURL);
              previewURL = null;
              previewImg.removeAttribute('src');
            }
          });
    </script>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBHKeAPNOEOZM4GGJ4Ylwrh2nP0rgJ_Pk8&libraries=places&callback=initMap" async defer></script>

}
