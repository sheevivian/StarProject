@using StarProject.ViewModels
@model StarProject.ViewModels.ParticipantsIndexVm

@{
    ViewData["Title"] = "報名管理";
    var cards = Model?.Cards ?? new List<EventCardVm>();
}

<!-- Debug：確認伺服端有把資料帶進來 -->
<div class="text-white small">DEBUG cards.Count = @cards.Count</div>

<div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="fw-bold text-white">報名管理</h1>
    <div class="d-flex gap-2">
        <a class="btn btn-outline-light" asp-controller="Participants" asp-action="ExportExcel">匯出全部 Excel</a>
        <a class="btn btn-outline-light" asp-controller="Participants" asp-action="ExportCsv">匯出全部 CSV</a>
    </div>
</div>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success">@TempData["Success"]</div>
}
@if (TempData["Error"] != null)
{
    <div class="alert alert-danger">@TempData["Error"]</div>
}

<section class="wrapper">
    <div class="container">
        <div class="row">
            @if (!cards.Any())
            {
                <div class="col-12">
                    <div class="alert alert-warning">目前沒有可顯示的活動。</div>
                </div>
            }
            else
            {
                @foreach (var e in cards)
                {
                    // 背景圖路徑正規化：支援 http/https、~/、/、純檔名（預設 ~/uploads）
                    var raw = e.CoverImageUrl ?? "";
                    string bg;
                    if (string.IsNullOrWhiteSpace(raw))
                    {
                        bg = "https://images.unsplash.com/photo-1444703686981-a3abbc4d4fe3?q=80&w=1400&auto=format&fit=crop";
                    }
                    else if (raw.StartsWith("http", StringComparison.OrdinalIgnoreCase))
                    {
                        bg = raw;
                    }
                    else
                    {
                        var normalized = (raw.StartsWith("~/") || raw.StartsWith("/")) ? raw : $"~/uploads/{raw}";
                        bg = Url.Content(normalized);
                    }

                    <div class="col-sm-12 col-md-6 col-lg-4 mb-4">
                        <div class="card text-dark card-has-bg click-col"
                             style="background-image:url('@bg');"
                             data-event-id="@e.No"
                             data-event-title="@e.Title"
                             role="button" aria-label="檢視 @e.Title 的報名名單">
                            <img class="card-img d-none" src="@bg" alt="@e.Title" />
                            <div class="card-img-overlay d-flex flex-column">
                                <div class="card-body">
                                    <small class="card-meta mb-2">@e.Category</small>
                                    <h4 class="card-title mt-0 text-dark">@e.Title</h4>
                                    <small><i class="far fa-clock me-1"></i>@e.StartDate.ToString("yyyy/MM/dd HH:mm")</small>
                                </div>
                                <div class="card-footer">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <div class="d-flex align-items-center gap-2">
                                            <i class="bi bi-people"></i>
                                            <span>@e.CurrentCount / @e.MaxParticipants 人</span>
                                        </div>
                                        <div class="d-flex align-items-center gap-2">
                                            <i class="bi bi-geo-alt"></i>
                                            <small>@e.Location</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            }
        </div>
    </div>
</section>

<!-- Modal & Scripts & Styles 保持原樣（略） -->
@section Styles {
    <style>
        body {
            background: #161616;
        }

        h1 {
            color: #fff;
        }

        .wrapper {
            margin: 2rem 0;
        }

        .card {
            border: none;
            transition: all 500ms cubic-bezier(0.19,1,0.22,1);
            overflow: hidden;
            border-radius: 20px;
            min-height: 450px;
            box-shadow: 0 0 12px 0 rgba(0,0,0,0.2);
        }

        @@media (max-width: 768px) {
            .card {
                min-height: 350px;
            }
        }

        @@media (max-width: 420px) {
            .card {
                min-height: 300px;
            }
        }

        .card.card-has-bg {
            background-size: 120%;
            background-repeat: no-repeat;
            background-position: center center;
            position: relative;
        }

            .card.card-has-bg:before {
                content: '';
                position: absolute;
                inset: 0;
                background: inherit;
                filter: grayscale(100%);
            }

            .card.card-has-bg:hover {
                transform: scale(0.98);
                box-shadow: 0 0 5px -2px rgba(0,0,0,0.3);
                background-size: 130%;
            }

        .card .card-img-overlay {
            position: relative;
            background: linear-gradient(0deg, rgba(255,186,33,0.38) 0%, rgba(255,186,33,1) 100%);
            transition: all 800ms cubic-bezier(0.19,1,0.22,1);
        }

        .card:hover .card-img-overlay {
            background: linear-gradient(0deg, rgba(255,186,33,0.5) 0%, rgba(255,186,33,1) 100%);
        }

        .card .card-body {
            transition: all 500ms cubic-bezier(0.19,1,0.22,1);
        }

        .card:hover .card-body {
            margin-top: 10px;
        }

        .card .card-title {
            font-weight: 800;
        }

        .card .card-meta {
            color: rgba(0,0,0,0.55);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 1px;
        }

        .card .card-footer {
            background: none;
            border-top: none;
        }

        #participantsTableContainer table td, #participantsTableContainer table th {
            vertical-align: middle;
        }
    </style>
}
