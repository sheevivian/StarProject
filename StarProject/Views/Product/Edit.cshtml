@model StarProject.ViewModels.ProductEditViewModel

@{
    ViewData["Title"] = "商品編輯";
}

<head>
    <style>
        * {
            padding: 0;
            margin: 0;
        }

        .btn-topbar {
            --bs-btn-bg: rgb(250, 208, 72);
            --bs-btn-border-color: rgb(250, 208, 72);
            --bs-btn-hover-bg: rgba(250, 208, 72, 0.692);
            --bs-btn-hover-border-color: rgba(250, 208, 72, 0.692);
            --bs-btn-focus-shadow-rgb: 217, 164, 6;
            --bs-btn-active-bg: #ffcd39;
            --bs-btn-active-border-color: #ffc720;
            --bs-btn-active-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
        }

        .btn-outline-back {
            --bs-btn-color: #DC3545;
            --bs-btn-border-color: #DC3545;
            --bs-btn-hover-color: #DC3545;
            --bs-btn-hover-bg: #f8e6e9;
            --bs-btn-hover-border-color: #DC3545;
            --bs-btn-focus-shadow-rgb: 255, 193, 7;
            --bs-btn-active-color: #DC3545;
            --bs-btn-active-border-color: #DC3545;
            --bs-btn-active-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
            --bs-gradient: none;
        }

        .btn-outline-excel {
            --bs-btn-color: rgb(0, 0, 0);
            --bs-btn-border-color: rgb(0, 0, 0);
            --bs-btn-hover-color: rgb(0, 0, 0);
            --bs-btn-hover-bg: rgba(250, 208, 72, 0.692);
            --bs-btn-hover-border-color: rgb(0, 0, 0);
            --bs-btn-focus-shadow-rgb: 255, 193, 7;
            --bs-btn-active-color: rgb(0, 0, 0);
            --bs-btn-active-border-color: rgb(0, 0, 0);
            --bs-btn-active-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
            --bs-gradient: none;
        }

        .del-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            color: rgba(255, 255, 255);
            margin-right: 4px;
            background: transparent;
            text-shadow: rgba(220, 220, 220, 0.8) 1px 1px 5px;
            border: none;
            cursor: pointer;
            font-size: 30px; /* 控制 icon 大小 */
            transition: color 0.2s ease; /* 滑鼠移過去會有漸變 */
        }

        .del-btn:hover {
                color: rgb(240, 240, 240);
        }
    </style>
</head>
<div class="d-flex">
    <h1 class="fw-bold">商品編輯</h1>
    <div class="ms-auto">
        <a asp-action="Index" class="btn btn-outline-back flex-fill fw-bold fs-5">返回列表</a>
    </div>
</div>
<div class="p-4 mt-3 rounded-4 bg-white">
    <h3 class="fw-bold mb-3"><i class="fa-solid fa-circle-info me-2"></i>基本資料</h3>
    <div class="row m-1 border border-1 rounded">
        <div class="col-6 m-5">
            <form asp-action="Edit">
                <div class="form-group d-flex align-items-center mb-3 row">
                    <div class="col-4 col-lg-2 fw-bold fs-5">
                        <label asp-for="Product.No" class="control-label"></label>
                    </div>
                    <div class="col-8 col-lg-10">
                        <input asp-for="Product.No" readonly class="form-control-plaintext" />
                    </div>
                </div>
                <div class="form-group d-flex align-items-center mb-3 row">
                    <div class="col-4 col-lg-2 fw-bold fs-5">
                        <label asp-for="Product.Name" class="control-label"></label>
                    </div>
                    <div class="col-8 col-lg-10">
                        <input asp-for="Product.Name" class="form-control" placeholder="商品名稱不可超過30個字" />
                        <span asp-validation-for="Product.Name" class="text-danger"></span>
                    </div>
                </div>
                <div class="form-group d-flex align-items-center mb-3 row">
                    <div class="col-4 col-lg-2 fw-bold fs-5">
                        <label asp-for="Product.ProCategoryNoNavigation.Name" class="control-label"></label>
                    </div>
                    <div class="col-8 col-lg-10">
                        <select asp-for="Product.ProCategoryNo" class="form-select" asp-items="ViewBag.ProCategoryName"></select>
                    </div>
                </div>
                <div class="form-group d-flex align-items-center mb-3 row">
                    <div class="col-4 col-lg-2 fw-bold fs-5">
                        <label asp-for="Product.Price" class="control-label"></label>
                    </div>
                    <div class="col-8 col-lg-10">
                        <input asp-for="Product.Price" class="form-control" />
                        <span asp-validation-for="Product.Price" class="text-danger"></span>
                    </div>
                </div>
                <div class="form-group d-flex align-items-center mb-3 row">
                    <div class="col-4 col-lg-2 fw-bold fs-5">
                        <label asp-for="Product.Status" class="control-label"></label>
                    </div>
                    <div class="col-8 col-lg-10">
                        <select asp-for="Product.Status" class="form-select" asp-items="ViewBag.StatusList"></select>
                    </div>
                </div>
                <div class="form-group d-flex align-items-center mb-3 row">
                    <div class="col-4 col-lg-2 fw-bold fs-5">
                        <label asp-for="Product.ReleaseDate" class="control-label"></label>
                    </div>
                    <div class="col-8 col-lg-10">
                        <input asp-for="Product.ReleaseDate" class="form-control" value="@(Model.Product.ReleaseDate.ToString("yyyy-MM-dd"))" />
                        <span asp-validation-for="Product.ReleaseDate" class="text-danger"></span>
                    </div>
                </div>
                <div class="form-group d-flex justify-content-end mt-2">
                    <button type="submit" class="btn btn-topbar fw-bold fs-5 col-6">
                        <i class="fa-solid fa-file"></i>保存變更
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<div class="p-4 mt-3 rounded-4 bg-white">
    <h3 class="fw-bold mb-3"><i class="fa-solid fa-images me-2"></i>商品圖片</h3>
    <div class="row m-1 border border-1 rounded">
        <div class="col-6 m-5">
            <div id="imgContainer" style="display:flex; gap:5px; flex-wrap:wrap; width:1300px;">
                <partial name="_PicturePartial" id="_PicturePartial"/>
            </div>
            <div class="border border-2 rounded rounded-3 p-3 mt-4 mb-3">
                <form asp-controller="Product" asp-action="ImgUpload" id="ImgEdit" method="post" enctype="multipart/form-data">
                    <!-- 補hidden，讓binder知道ProImages存在 -->
                    <input type="hidden" asp-for="Product.No" />
                    <input type="hidden" asp-for="ProImage.ProductNo" value="@Model.Product.No" />
                    <div id="previewContainer" class="mt-2 ms-3" style="display:flex; gap:5px; flex-wrap:wrap;">
                        <!-- 縮圖動態生成 -->
                    </div>
                    <div class="mt-3 ms-3 mb-3 d-flex">
                        <!-- 真正的input隱藏 -->
                        <input type="file" asp-for="ImageFiles" id="ImageFiles" class="d-none" accept="image" multiple />
                        <!-- 自訂的觸發按鈕 -->
                        <label for="ImageFiles" class="align-self-center btn btn-secondary rounded-0 rounded-start fs-5">選擇圖片</label>
                        <!-- 顯示已選幾張 -->
                        <label id="fileCount" class="align-self-center text-muted border border-1 fs-5" style="width: 60%; padding: 6px 0 6px 12px;">尚未選擇圖片</label>
                        <!-- 上傳按鈕 -->
                        <button type="submit" class="align-self-center btn btn-primary btnUpload rounded-0 rounded-end fs-5">上傳圖片</button>
                    </div>
                </form>
            </div>
            <div class="d-flex justify-content-end mt-2">
                <button id="img-btn-save" class="btn btn-topbar fw-bold fs-5 col-6"><i class="fa-solid fa-file"></i>保存變更</button>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<script>
    $(document).ready(function () {

        let deletedIds = [];            // 刪除的舊檔案 id
        let fileList = [];              // 暫存新選擇檔案
        const maxFiles = 5;             // 最大數量

        // 🔹刪除舊檔案 (資料庫已有的)
        $(document).on('click', '.del-btn', function () {
            const imgId = $(this).closest('.imgdiv').data("imgid");
            deletedIds.push(imgId);
            $(this).closest('.imgdiv').remove();

            // 更新計算
            updateFileCount();
            refreshPreview();
        });

        // 🔹儲存圖片順序
        $('#img-btn-save').on('click', function () {
            const ImgData = [];

            $('#imgContainer .imgdiv').each(function () {
                const OrderId = $(this).data('imgid');
                const OrderOd = parseInt($(this).find('.img-order').val()) || 0;
                ImgData.push({ OrderId, OrderOd });
            });

            let dataToSend = {
                ImgData: ImgData,
                DeletedIds: deletedIds
            };

            $.ajax({
                url: '/Product/ImgSave',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(dataToSend),
                success: function (res) {
                    $("#imgContainer").html(res);
                    deletedIds = [];
                    alert('修改成功！');

                    updateFileCount();
                    refreshPreview();
                },
                error: function (err) {
                    alert('修改失敗！');
                }
            });
        });

        // 🔹選擇檔案
        $("#ImageFiles").on("change", function () {
            const files = Array.from(this.files);

            // 計算現在畫面已有多少張舊檔案
            const existingCount = $("#imgContainer .imgdiv").length;

            // 剩下可新增的數量
            let remainingSlots = maxFiles - existingCount - fileList.length;

            if (remainingSlots <= 0) {
                alert("最多只能上傳 " + maxFiles + " 張圖片");
                $(this).val(""); // 清空選擇
                return;
            }

            files.slice(0, remainingSlots).forEach(file => {
                if (!file.type.match("image.*")) return;
                fileList.push(file);
            });

            $(this).val(""); // 清空 input → 避免相同檔案選擇不到

            updateFileCount();
            refreshPreview();
        });

        // 🔹送出表單 (上傳新檔案)
        $("#ImgEdit").on("submit", function (e) {
            e.preventDefault();

            const formData = new FormData(this);

            fileList.forEach(file => {
                formData.append("ImageFiles", file);
            });

            $.ajax({
                url: "/Product/ImgUpload",
                type: "POST",
                data: formData,
                processData: false,
                contentType: false,
                success: function (res) {
                    $("#imgContainer").html(res);
                    alert("上傳成功！");

                    // 清空暫存
                    fileList = [];
                    updateFileCount();
                    refreshPreview();
                },
                error: function (err) {
                    alert("上傳失敗：" + err.responseText);
                }
            });
        });

        // 🔹顯示檔案數量
        function updateFileCount() {
            const existingCount = $("#imgContainer .imgdiv").length;
            const total = existingCount + fileList.length;

            $("#fileCount").text("目前共有 " + total + " 張圖片 (最多 " + maxFiles + " 張)");
        }

        // 🔹預覽新選檔案
        function refreshPreview() {
            const previewContainer = $("#previewContainer");
            previewContainer.empty();

            fileList.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const card = $("<div>");

                    const wrapper = $("<div>").css({
                        position: "relative",
                        width: "200px",
                        height: "200px",
                        margin: "2px"
                    });

                    const img = $("<img>")
                        .attr("src", e.target.result)
                        .attr("title", file.name)
                        .css({
                            width: "100%",
                            height: "100%",
                            objectFit: "cover",
                            border: "1px solid #ccc",
                            padding: "2px"
                        });

                    // 刪除按鈕 (刪新選檔案)
                    const delBtn = $("<button>")
                        .html(`<i class="fa-solid fa-square-xmark"></i>`)
                        .addClass("del-btn")
                        .css({
                            position: "absolute",
                            top: "5px",
                            right: "5px"
                        })
                        .on("click", function () {
                            fileList.splice(index, 1);
                            refreshPreview();
                            updateFileCount();
                        });

                    // 圖片順序
                    const order = $("<div>")
                        .addClass("d-flex justify-content-end align-items-center");

                    const label = $("<label>")
                        .text("圖片順序:")
                        .addClass("p-0 fs-5")
                        .css({ width: "100px" });

                    const input = $('<input>')
                        .attr({
                            type: 'number',
                            name: `ImageOrders[${index}]`,
                            min: 1,
                            max: maxFiles
                        })
                        .addClass("form-control")
                        .css({ width: "60px" })
                        .val(index + 1);

                    wrapper.append(img).append(delBtn);
                    order.append(label).append(input);
                    card.append(wrapper).append(order);
                    previewContainer.append(card);
                };
                reader.readAsDataURL(file);
            });
        }

        // 預設初始化
        updateFileCount();
        refreshPreview();
    });
</script>
