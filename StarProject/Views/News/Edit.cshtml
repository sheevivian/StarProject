@using StarProject.ViewModels
@model NewsVM

@{
    ViewData["Title"] = "官網公告編輯";
}

<head>
    <link href="~/css/textediting.css" rel="stylesheet" />
    <style>
        .btn-edit {
            --bs-btn-color: #fff;
            --bs-btn-bg: #0d6efd;
            --bs-btn-border-color: #0d6efd;
            --bs-btn-hover-color: #fff;
            --bs-btn-hover-bg: #527bcc;
            --bs-btn-hover-border-color: #0d6efd;
            --bs-btn-focus-shadow-rgb: 217, 164, 6;
            --bs-btn-active-color: #fff;
            --bs-btn-active-bg: #527bcc;
            --bs-btn-active-border-color: #0d6efd;
            --bs-btn-active-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
        }

        .btn-outline-back {
            --bs-btn-color: #DC3545;
            --bs-btn-border-color: #DC3545;
            --bs-btn-hover-color: #DC3545;
            --bs-btn-hover-bg: #f8e6e9;
            --bs-btn-hover-border-color: #DC3545;
            --bs-btn-focus-shadow-rgb: 255, 193, 7;
            --bs-btn-active-color: #DC3545;
            --bs-btn-active-border-color: #DC3545;
            --bs-btn-active-shadow: inset 0 3px 5px rgba(0, 0, 0, 0.125);
            --bs-gradient: none;
        }

        .ck-editor__editable {
            min-height: 430px; /* 編輯區最小高度 */
        }

        #carouselExampleIndicators .carousel-inner {
            height: 500px; /* 你想要的高度 */
        }

            #carouselExampleIndicators .carousel-inner .carousel-item img {
                height: 100%;
                width: auto; /* 保持比例 */
                object-fit: cover; /* 填滿容器裁切 */
            }

        .card-header {
            background-color: #2B4C8C;
            color: #FFFFFF
        }

        .sortable-placeholder {
            background: #f0f0f0;
            border: 2px dashed #bbb;
            height: 100px; /* 依你 li 的高度調整 */
            border-radius: 8px;
        }
    </style>

</head>

<h1 class="fw-bold">官網公告編輯</h1>
<hr />

<div class="row">
    <form asp-action="Edit" method="post" enctype="multipart/form-data" style="width:100%">
        <div asp-validation-summary="ModelOnly" class="text-danger"></div>
        <input type="hidden" asp-for="No" />
        <div class="row g-3 align-items-stretch">
            <!-- 左側：基本資訊 + 圖片 -->
            <div class="col-lg-6 d-flex flex-column gap-3">
                <div class="card  h-100">
                    <div class="card-header fw-bold fs-4"><strong>公告資訊</strong></div>
                    <div class="card-body">
                        <div class="form-group mb-2">
                            <label asp-for="Title" class="control-label fw-bold fs-5"></label><span asp-validation-for="Title" class="text-danger ms-3"></span>
                            <input asp-for="Title" class="form-control" />
                        </div>

                        <div class="form-group mb-2">
                            <label asp-for="Category" class="control-label fw-bold fs-5"></label><span asp-validation-for="Category" class="text-danger ms-3"></span>
                            <select asp-for="Category" class="form-select">
                                <option value="">請選擇</option>
                                <option value="最新消息">最新消息</option>
                                <option value="館區動態">館區動態</option>
                                <option value="活動資訊">活動資訊</option>
                                <option value="最新天象">最新天象</option>
                                <option value="觀測公告">觀測公告</option>
                                <option value="宇宙探索">宇宙探索</option>
                                <option value="系統公告">系統公告</option>
                                <option value="其他消息">其他消息</option>
                            </select>
                        </div>

                        <div class="form-group mb-2">
                            <label asp-for="PublishDate" class="control-label fw-bold fs-5"></label><span asp-validation-for="PublishDate" class="text-danger ms-3"></span>
                            <input asp-for="PublishDate" class="form-control" />
                        </div>

                        <div class="form-group mb-2">
                            <label asp-for="Content" class="control-label fw-bold fs-5"></label><span asp-validation-for="Content" class="text-danger ms-3"></span>
                            <textarea asp-for="Content" id="editor" class="form-control"></textarea>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右側：圖片區 -->
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header fw-bold fs-4"><strong>公告封面</strong></div>
                    <div class="card-body d-flex flex-column">
                        <!-- 多圖上傳 -->
                        <div class="mb-3">
                            <label class="form-label fw-bold fs-5">上傳圖片</label><small class="text-muted ms-3">可選多張上傳</small>
                            <input type="file" class="form-control" multiple id="imageFilesInput" name="ImageFiles" />
                        </div>

                        <!-- Carousel 預覽 + 拖曳排序 -->
                        <div class="mb-3">
                            <div id="carouselExampleIndicators" class="carousel slide">
                                <div class="carousel-indicators" id="carouselIndicators">
                                    @for (int i = 0; i < Model.Images.Count; i++)
                                    {
                                        <button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="@i"
                                                class="@(i == 0 ? "active" : "")" aria-current="@(i == 0 ? "true" : "false")"></button>
                                    }
                                </div>
                                <div class="carousel-inner" id="carouselInner">
                                    @for (int i = 0; i < Model.Images.Count; i++)
                                    {
                                        <div class="carousel-item @(i == 0 ? "active" : "")">
                                            <img src="@Model.Images[i]" class="d-block w-100" style="height:500px; object-fit:cover;object-position: center;">
                                        </div>
                                    }
                                </div>
                                <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">上一張</span>
                                </button>
                                <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="next">
                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                    <span class="visually-hidden">下一張</span>
                                </button>
                            </div>
                        </div>

                        <!-- 縮圖拖曳區 -->
                        <div class="mb-2">
                            <ul id="imagePreviewList" class="list-unstyled d-flex gap-2">
                                <!-- 新增：顯示舊圖片縮圖 -->
                                @for (int i = 0; i < Model.Images.Count; i++)
                                {
                                    var imgUrl = Model.Images[i];
                                    var imgId = Model.ImageIds[i]; // 舊圖 Id
                                    <li class="position-relative d-inline-block me-2" style="width:100px;height:80px;" data-id="@imgId">
                                        <img src="@imgUrl" class="img-thumbnail w-100 h-100" style="object-fit:cover;">
                                        <button type="button" class="btn-close btn-close-white position-absolute remove-old-btn" style="top:2px;right:2px;"></button>
                                        <input type="hidden" name="ImageOrderMap[@imgId]" value="@(i + 1)" />
                                    </li>
                                }
                            </ul>
                            <small id="dragTip" class="text-muted" style="display:none;">可拖曳排序圖片</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="form-group d-flex gap-3 mt-3 text-distance justify-content-center">
            <button type="submit" class="btn btn-edit fw-bold fs-5 text-distance" style="width:303px">
                <i class="fa-solid fa-pen-nib"></i>修改
            </button>
            <a asp-action="Index" class="btn btn-outline-back fw-bold fs-5" style="width:303px">返回列表</a>
        </div>
    </form>
</div>


@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <script src="~/lib/ckeditor5-build-classic-master/build/ckeditor.js"></script>

    <script>
        const imageFilesInput = document.getElementById('imageFilesInput');
        const imagePreviewList = $('#imagePreviewList');
        const carouselInner = $('#carouselInner');
        const carouselIndicators = $('#carouselIndicators');
        let fileList = []; // 新圖暫存
        let oldImages = []; // 舊圖暫存 {id, url}
        let currentOrder = []; // 紀錄目前的顯示順序 (元素可能是 {type:'old', id} 或 {type:'new', index})

        // 初始將舊圖加入 oldImages
        $('#imagePreviewList li').each(function(){
            const li = $(this);
            const id = li.data('id');
            oldImages.push({id: id, url: li.find('img').attr('src')});
            currentOrder.push({type:'old', id:id});
        });

                // 綁刪除舊圖
        function bindRemoveOld(){
            $('.remove-old-btn').off('click').on('click', function(){
                const li = $(this).closest('li');
                const imgId = li.data('id');
                $('<input>',{type:'hidden',name:'DeleteImageIds',value:imgId}).appendTo('form');
                oldImages = oldImages.filter(x => x.id != imgId);
                currentOrder = currentOrder.filter(x => !(x.type=='old' && x.id==imgId));
                updatePreview();
            });
        }

        // 上傳新圖
        imageFilesInput.addEventListener('change', () => {
            Array.from(imageFilesInput.files).forEach(file=>{
                const newIndex = fileList.length;
                fileList.push({file:file, previewUrl:URL.createObjectURL(file), index:newIndex});
                currentOrder.push({type:'new', index:newIndex});
            });
            updatePreview();
        });

        // updatePreview 改成依 currentOrder 排列
        function updatePreview(){
            imagePreviewList.empty();
            carouselInner.empty();
            carouselIndicators.empty();

            let orderCounter = 1;
            let count=0;

            currentOrder.forEach(item=>{
                if(item.type=='old'){
                    const img = oldImages.find(x=>x.id==item.id);
                    if(!img) return; // 已刪除
                    const li = $(`
                        <li class="position-relative d-inline-block me-2" style="width:100px;height:80px;"
                            data-type="old" data-id="${img.id}">
                            <img src="${img.url}" class="img-thumbnail w-100 h-100" style="object-fit:cover;">
                            <button type="button" class="btn-close btn-close-white position-absolute remove-old-btn"
                                    style="top:2px;right:2px;"></button>
                            <input type="hidden" name="ImageOrderMap[${img.id}]" value="${orderCounter++}" />
                        </li>
                    `);
                    imagePreviewList.append(li);

                    const citem = $(`<div class="carousel-item${count==0?' active':''}" data-type="old" data-id="${img.id}">
                                        <img src="${img.url}" class="d-block w-100" style="height:500px; object-fit:cover;object-position: center;">
                                     </div>`);
                    carouselInner.append(citem);
                    carouselIndicators.append(`<button type="button" data-bs-target="#carouselExampleIndicators"
                        data-bs-slide-to="${count}" ${count==0?'class="active" aria-current="true"':''}></button>`);
                    count++;

                } else if(item.type=='new'){
                    const obj = fileList[item.index];
                    if(!obj) return; // 已刪除
                    const li = $(`
                        <li class="position-relative d-inline-block me-2" style="width:100px;height:80px;"
                            data-type="new" data-index="${item.index}">
                            <img src="${obj.previewUrl}" class="img-thumbnail w-100 h-100" style="object-fit:cover;">
                            <button type="button" class="btn-close btn-close-white position-absolute remove-btn"
                                    style="top:2px;right:2px;"></button>
                            <input type="hidden" name="ImageOrderNos" value="${orderCounter++}" data-index="${item.index}" />
                        </li>
                    `);
                    li.find('.remove-btn').click(()=>{
                        fileList[item.index] = null; // 不直接 splice，避免 index 跑掉
                        currentOrder = currentOrder.filter(x => !(x.type=='new' && x.index==item.index));
                        updatePreview();
                    });
                    imagePreviewList.append(li);

                    const citem = $(`<div class="carousel-item${count==0?' active':''}" data-type="new" data-index="${item.index}">
                                        <img src="${obj.previewUrl}" class="d-block w-100" style="height:500px; object-fit:cover;object-position: center;">
                                     </div>`);
                    carouselInner.append(citem);
                    carouselIndicators.append(`<button type="button" data-bs-target="#carouselExampleIndicators"
                        data-bs-slide-to="${count}" ${count==0?'class="active" aria-current="true"':''}></button>`);
                    count++;
                }
            });

            bindRemoveOld();
            $('#dragTip').toggle(imagePreviewList.children('li').length>1);
        }

        // 拖曳排序，更新 currentOrder
        imagePreviewList.sortable({
            placeholder: "sortable-placeholder",
            opacity: 0.8,
            cursor: "move",
            update: function(){
                let newOrder = [];
                let orderCounter = 1;

                imagePreviewList.children('li').each((i,li)=>{
                    const $li = $(li);
                    const type = $li.data('type');
                    if(type=='old'){
                        const id = $li.data('id');
                        $(`input[name='ImageOrderMap[${id}]']`).val(orderCounter++);
                        newOrder.push({type:'old', id:id});
                    } else {
                        const idx = $li.data('index');
                        $(`input[name='ImageOrderNos'][data-index='${idx}']`).val(orderCounter++);
                        newOrder.push({type:'new', index:idx});
                    }
                });

                currentOrder = newOrder;
                updatePreview();
            }
        });

        // 初始化
        updatePreview();
    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const textarea = document.querySelector('#editor');

            ClassicEditor
                .create(textarea, {
                    language: 'zh',
                    toolbar: [
                        'heading', '|',
                        'bold', 'italic', 'blockQuote', 'bulletedList', 'numberedList', '|',
                        'imageUpload', 'link', 'mediaEmbed', 'insertTable', '|',
                        'undo', 'redo'
                    ],
                    ckfinder: {
                        uploadUrl: '/CompanyNotifies/UploadImage'
                    }
                })
                .then(editor => {
                    // 只綁一次事件
                    editor.model.document.on('change:data', () => {
                        textarea.value = editor.getData();
                        // console.log(textarea.value); // 可以保留或刪掉
                    });
                })
                .catch(error => {
                    console.error(error);
                });
        });
    </script>
}