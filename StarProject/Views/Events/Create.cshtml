@model StarProject.ViewModel.EventInfoVM

@{
    ViewData["Title"] = "新增活動";
}

<style>
    .card-header {
        background-color: #2B4C8C !important;
        color: #fff !important;
    }
    .card-header * {
            color: inherit;
        }
    /* ====== Create頁專用 - 一鍵輸入按鈕樣式（與 Promotion.css 的 .btn-search 一致） ====== */
    .btn-search {
        --bs-btn-bg: rgb(250, 208, 72);
        --bs-btn-border-color: rgb(250, 208, 72);
        --bs-btn-hover-bg: rgba(250, 208, 72, 0.692);
        --bs-btn-hover-border-color: rgba(250, 208, 72, 0.692);
        --bs-btn-focus-shadow-rgb: 217, 164, 6;
        --bs-btn-active-bg: #ffcd39;
        --bs-btn-active-border-color: #ffc720;
        --bs-btn-active-shadow: inset 0 3px 5px rgba(0,0,0,.125);
    }

</style>


<div class="d-flex align-items-center justify-content-between mb-2">
    <h1 class="fw-bold mb-0">快速新增活動</h1>

    <!-- 一鍵輸入按鈕（右上角） -->
    <button type="button" class="btn btn-search fw-bold" id="demoDataBtn" onclick="fillDemoData()">
        <i class="fa-solid fa-wand-magic-sparkles"></i> 一鍵輸入
    </button>
</div>
<hr />

<div class="row">
    <div class="d-flex">
        <form asp-action="Create" method="post" enctype="multipart/form-data" class="w-100">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            <div class="row g-4">
                <!-- 左欄：基本資料 + 費用/說明 -->
                <div class="col-lg-7">
                    <div class="card">
                        <div class="card-header card-header"><strong>基本資料</strong></div>
                        <div class="card-body">
                            <div class="mb-2">
                                <label class="control-label fw-bold fs-6">活動編號</label>
                                <input type="text" class="form-control" value="系統自動編號無須輸入" disabled
                                       style="background-color:#e9ecef;cursor:not-allowed;" />
                            </div>

                            <div class="mb-2">
                                <label asp-for="Title" class="control-label fw-bold fs-6">活動名稱</label>
                                <input asp-for="Title" class="form-control" />
                                <span asp-validation-for="Title" class="text-danger"></span>
                            </div>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label asp-for="Category" class="control-label fw-bold fs-6">活動種類</label>
                                    <select asp-for="Category" class="form-select">
                                        <option value="星學課程">星學課程</option>
                                        <option value="星知講座">星知講座</option>
                                        <option value="星境營隊">星境營隊</option>
                                        <option value="星耀計畫">星耀計畫</option>
                                        <option value="星樂工作坊">星樂工作坊</option>
                                        <option value="星動旅程">星動旅程</option>
                                        <option value="星趣親子時光">星趣親子時光</option>
                                    </select>
                                    <span asp-validation-for="Category" class="text-danger"></span>
                                </div>
                                <div class="col-md-6">
                                    <label asp-for="Location" class="control-label fw-bold fs-6">活動地點</label>
                                    <select asp-for="Location" class="form-select">
                                        <option value="第一演講室">第一演講室</option>
                                        <option value="第二演講室">第二演講室</option>
                                        <option value="屋頂天文台">屋頂天文台</option>
                                        <option value="戶外廣場">戶外廣場</option>
                                        <option value="多功能教室">多功能教室</option>
                                        <option value="實驗教室">實驗教室</option>
                                        <option value="觀測室">觀測室</option>
                                        <option value="天文館">天文館</option>
                                        <option value="天文館大廳報到">天文館大廳報到</option>
                                    </select>
                                    <span asp-validation-for="Location" class="text-danger"></span>
                                </div>
                            </div>

                            <div class="row g-3 mt-0">
                                <div class="col-md-6">
                                    <label asp-for="MaxParticipants" class="control-label fw-bold fs-6">人數上限</label>
                                    <select asp-for="MaxParticipants" class="form-select">
                                        <option value="30">30</option>
                                        <option value="38">38</option>
                                        <option value="50">50</option>
                                        <option value="100">100</option>
                                        <option value="200">200</option>
                                    </select>
                                    <span asp-validation-for="MaxParticipants" class="text-danger"></span>
                                </div>
                                <div class="col-md-6">
                                    <label asp-for="Status" class="control-label fw-bold fs-6">活動狀態</label>
                                    <select asp-for="Status" class="form-select">
                                        <option value="報名中">報名中</option>
                                        <option value="已額滿">已額滿</option>
                                        <option value="已結束">已結束</option>
                                        <option value="已取消">已取消</option>
                                    </select>
                                    <span asp-validation-for="Status" class="text-danger"></span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-3">
                        <div class="card-header card-header"><strong>費用與說明</strong></div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label asp-for="Fee" class="control-label fw-bold fs-6">活動費用</label>
                                    <input asp-for="Fee" class="form-control" />
                                    <span asp-validation-for="Fee" class="text-danger"></span>
                                </div>
                                <div class="col-md-6">
                                    <label asp-for="Deposit" class="control-label fw-bold fs-6">預定訂金</label>
                                    <input asp-for="Deposit" class="form-control" />
                                    <span asp-validation-for="Deposit" class="text-danger"></span>
                                </div>
                            </div>

                            <div class="mt-3">
                                <label asp-for="Desc" class="control-label fw-bold fs-6">活動說明</label>
                                <textarea asp-for="Desc" class="form-control" rows="6" style="resize:none;"
                                          placeholder="請輸入活動說明..."></textarea>
                                <span asp-validation-for="Desc" class="text-danger"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 右欄：時間與發佈 -->
                <div class="col-lg-5">
                    <div class="card">
                        <div class="card-header card-header"><strong>時間與發佈</strong></div>
                        <div class="card-body">
                            <div class="mb-2">
                                <label asp-for="StartDate" class="control-label fw-bold fs-6">開始時間</label>
                                <input asp-for="StartDate" class="form-control" type="datetime-local"
                                       asp-format="{0:yyyy-MM-ddTHH:mm}" step="60" />
                                <span asp-validation-for="StartDate" class="text-danger"></span>
                            </div>

                            <div class="mb-2">
                                <label asp-for="EndDate" class="control-label fw-bold fs-6">結束時間</label>
                                <input asp-for="EndDate" class="form-control" type="datetime-local"
                                       asp-format="{0:yyyy-MM-ddTHH:mm}" step="60" />
                                <span asp-validation-for="EndDate" class="text-danger"></span>
                            </div>


                            <div class="mb-2">
                                <label class="control-label fw-bold fs-6">發佈方式</label>
                                <div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="PublishMode" id="pmNow"
                                               value="now" checked>
                                        <label class="form-check-label" for="pmNow">立即發佈</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="radio" name="PublishMode" id="pmSchedule"
                                               value="schedule">
                                        <label class="form-check-label" for="pmSchedule">排程時間</label>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-2">
                                <label class="control-label fw-bold fs-6">開始發佈時間</label>
                                <input type="datetime-local" class="form-control" name="ReleaseDate" id="ReleaseDate"
                                       value="@(ViewBag.ScheduleReleaseDate ?? "")" disabled />
                            </div>
                            <div class="mb-2">
                                <label class="control-label fw-bold fs-6">下架時間（可空白）</label>
                                <input type="datetime-local" class="form-control" name="ExpirationDate"
                                       id="ExpirationDate" value="@(ViewBag.ScheduleExpirationDate ?? "")" disabled />
                                <small class="text-muted">＊不設定代表不下架</small>
                            </div>
                        </div>

                    </div>

                    <!-- 右欄：圖片上傳 -->
                    <div class="card mt-3">
                        <div class="card-header card-header"><strong>圖片上傳</strong></div>
                        <div class="card-body">
                            <div class="input-group">
                                <input asp-for="ImageFile" id="ImageFile" class="form-control" type="file"
                                       accept="image/*">
                                <button type="button" class="btn btn-outline-secondary" id="btnPreviewImage">預覽</button>
                            </div>
                            <span asp-validation-for="ImageFile" class="text-danger"></span>
                            <small class="text-muted d-block mt-1">* 建議圖片檔案大小較小為佳</small>
                        </div>
                    </div>
                    <!-- 行動版顯示送出鍵 -->
                    <div class="mt-3 d-lg-none">
                        <input type="submit" value="儲存" class="btn btn-primary" />
                        <a asp-action="List" class="btn btn-secondary ms-2">返回列表</a>
                    </div>

                    <!-- PC版顯示送出鍵 -->
                    <div class="card-footer text-end d-none d-lg-block mt-3 py-3">
                        <input type="submit" value="儲存" class="btn btn-primary" />
                        <a asp-action="List" class="btn btn-secondary ms-2">返回列表</a>
                    </div>

                    <!-- 圖片預覽小視窗（Bootstrap 5 Modal） -->
                    <div class="modal fade" id="imagePreviewModal" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered modal-lg">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">圖片預覽</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="關閉"></button>
                                </div>
                                <div class="modal-body text-center">
                                    <img id="previewImg" alt="圖片預覽" class="img-fluid rounded border">
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-outline-danger"
                                            id="btnClearImage">
                                        移除檔案
                                    </button>
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">使用此圖片</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>


@section Scripts {
    @await Html.PartialAsync("_ValidationScriptsPartial")
    <script>
        // 把 Date 轉成本地 "yyyy-MM-ddTHH:mm"
        function toLocalDateTimeInputValue(date) {
            const pad = n => n.toString().padStart(2, '0');
            const y = date.getFullYear();
            const m = pad(date.getMonth() + 1);
            const d = pad(date.getDate());
            const hh = pad(date.getHours());
            const mm = pad(date.getMinutes());
            return `${y}-${m}-${d}T${hh}:${mm}`;
        }

        document.addEventListener('DOMContentLoaded', function () {
            // ====== 排程欄位啟用/停用 ======
            const pmNow = document.getElementById('pmNow');
            const pmSchedule = document.getElementById('pmSchedule');
            const release = document.getElementById('ReleaseDate');
            const expire = document.getElementById('ExpirationDate');

            function toggleScheduleInputs() {
                const schedule = pmSchedule && pmSchedule.checked;
                if (release) release.disabled = !schedule;
                if (expire) expire.disabled = !schedule;

                // 剛切到排程且尚未填值 → 自動放現在
                if (schedule && release && !release.value) {
                    release.value = toLocalDateTimeInputValue(new Date());
                    syncExpireMin();
                }
            }
            function syncExpireMin() {
                if (!expire || !release) return;
                expire.min = release.value || '';
                if (expire.value && release.value && expire.value < release.value) {
                    expire.value = '';
                }
            }
            if (release && release.value) { // 若初始就有值則切到「排程」
                if (pmSchedule) pmSchedule.checked = true;
                if (pmNow) pmNow.checked = false;
            }
            pmNow?.addEventListener('change', toggleScheduleInputs);
            pmSchedule?.addEventListener('change', toggleScheduleInputs);
            release?.addEventListener('change', syncExpireMin);
            release?.addEventListener('input', syncExpireMin);
            toggleScheduleInputs();
            syncExpireMin();

            // ====== 圖片預覽小視窗 ======
            const fileInput = document.getElementById('ImageFile');
            const previewBtn = document.getElementById('btnPreviewImage');
            const previewImg = document.getElementById('previewImg');
            const clearBtn = document.getElementById('btnClearImage');
            const modalEl = document.getElementById('imagePreviewModal');
            let previewURL = null;

            function showPreviewModal(file) {
                if (!file) { alert('請先選擇圖片'); return; }
                // 僅接受圖片
                if (!file.type.startsWith('image/')) { alert('請選擇圖片檔'); return; }

                if (previewURL) URL.revokeObjectURL(previewURL);
                previewURL = URL.createObjectURL(file);
                previewImg.src = previewURL;

                const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                modal.show();
            }

            // 選檔後自動預覽
            fileInput?.addEventListener('change', () => {
                const file = fileInput.files?.[0];
                if (file) showPreviewModal(file);
            });

            // 點「預覽」按鈕（可重看）
            previewBtn?.addEventListener('click', () => {
                const file = fileInput?.files?.[0];
                showPreviewModal(file);
            });

            // 關閉時釋放 URL（避免記憶體增加）
            modalEl?.addEventListener('hidden.bs.modal', () => {
                if (previewURL) {
                    URL.revokeObjectURL(previewURL);
                    previewURL = null;
                    previewImg.removeAttribute('src');
                }
            });

            // 移除檔案
            clearBtn?.addEventListener('click', () => {
                if (fileInput) fileInput.value = '';
                const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
                modal.hide();
            });

            // ====== 一鍵輸入（示範用資料） ======
            window.fillDemoData = function () {

              const $id = (x) => document.getElementById(x);
              const setSelect = (el, val) => {
                if (!el) return;
                const exists = [...el.options].some(o => o.value === val);
                if (!exists) { const opt = document.createElement('option'); opt.value = val; opt.textContent = val; el.appendChild(opt); }
                el.value = val;
                el.dispatchEvent(new Event('change'));
              };

              // 基本資料
              const title = $id('Title');
              if (title) title.value = '星座占卜：屬於我們的愛情密碼';

              setSelect($id('Category'), '星知講座');   // 活動種類
              setSelect($id('MaxParticipants'), '50');   // 人數上限

              // 費用
              const fee = $id('Fee');       if (fee)     fee.value = '100';
              const deposit = $id('Deposit');if (deposit)deposit.value = '100';

              // 說明
              const desc = $id('Desc');
              if (desc) desc.value =
            `這場活動結合了天文學知識與占星學的浪漫元素。
活動開始時，專業講師會簡介天文學上的星座劃分與起源，接著，將引導你們利用彼此的出生日期，找出專屬的「戀人星座圖」。
我們將共同解讀星座之間的關係、特質與配對，並探討這些天體如何「影響」我們的個性和情感互動。
這並非嚴肅的占卜，而是一個有趣又富有啟發性的互動體驗，讓你們透過星空，更深入地了解彼此，並找到屬於你們的愛情密碼。`;

              // 時間（保持固定格式）
              const start = $id('StartDate'); if (start) start.value = '2025-11-06T19:00';
              const end   = $id('EndDate');   if (end)   end.value   = '2025-11-06T20:30';

              // 發佈方式：切到「排程時間」，但保持時間空白
              const pmNow = $id('pmNow');
              const pmSchedule = $id('pmSchedule');
              const release = $id('ReleaseDate');
              const expire  = $id('ExpirationDate');

              if (pmSchedule) pmSchedule.checked = true;
              if (pmNow)      pmNow.checked = false;

              // 只啟用欄位，不自動填任何值
              if (release) { release.disabled = false; release.value = ''; }
              if (expire)  { expire.disabled  = false; expire.value  = ''; expire.min = ''; }

              // 不動：地點、狀態、圖片 → 維持目前頁面預設
            };

        });
    </script>
}