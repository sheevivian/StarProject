@model IEnumerable<StarProject.Models.Event>
@Html.AntiForgeryToken()
@using System.Text.Json

@{
    ViewData["Title"] = "活動列表";
}

@section Styles {
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        /* ✅ 僅在右側保留捲軸空間，避免左邊空白 */
        html {
            scrollbar-gutter: stable;
        }

        img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .img550px {
            width: 550px;
            height: 550px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 1px solid #ddd;
        }

        .offcanvas {
            --bs-offcanvas-width: 600px;
            --bs-offcanvas-padding-x: 1rem;
            --bs-offcanvas-padding-y: 0rem;
        }

        .form-check-input {
            border: var(--bs-border-width) solid gray;
        }

        .table > thead > tr > th {
            font-size: 18px !important;
            color: #fff;
            background-color: #2B4C8C;
            letter-spacing: .2rem;
        }

        .table > tbody > tr.active > td {
            background-color: rgba(223,245,255,.521) !important;
        }

        .table > tbody > tr > td {
            border-color: #D5D8DB !important;
        }

        .table tbody tr:hover td {
            background-color: #F4F1FF !important;
        }

        .table-rounded {
            border-radius: 10px;
            overflow: hidden;
        }

        .table {
            border-collapse: separate !important;
            border-spacing: 0;
            border-radius: 20px;
            overflow: hidden;
            vertical-align: middle;
        }

        .fs18px {
            font-size: 18px;
            letter-spacing: .1rem;
        }

        .fs14px {
            font-size: 14px;
        }

        .br20px {
            border-radius: 20px;
        }

        .btn-color {
            border: 1px solid gray;
            border-radius: 15px;
        }

            .btn-color:hover {
                background-color: #bbe3f3;
            }

        .btn-search {
            --bs-btn-bg: rgb(250,208,72);
            --bs-btn-border-color: rgb(250,208,72);
            --bs-btn-hover-bg: rgba(250,208,72,.692);
            --bs-btn-hover-border-color: rgba(250,208,72,.692);
            --bs-btn-focus-shadow-rgb: 217,164,6;
            --bs-btn-active-bg: #ffcd39;
            --bs-btn-active-border-color: #ffc720;
            --bs-btn-active-shadow: inset 0 3px 5px rgba(0,0,0,.125);
        }

        .btn-outline-search {
            --bs-btn-color: #ffc107;
            --bs-btn-border-color: #ffc107;
            --bs-btn-hover-color: #ffc107;
            --bs-btn-hover-bg: rgba(253,246,222,.897);
            --bs-btn-hover-border-color: #ffc107;
            --bs-btn-focus-shadow-rgb: 255,193,7;
            --bs-btn-active-color: #ffc107;
            --bs-btn-active-border-color: #ffc107;
            --bs-gradient: none;
        }

        .btn-outline-delect {
            --bs-btn-color: #DC3545;
            --bs-btn-border-color: #DC3545;
            --bs-btn-hover-color: #DC3545;
            --bs-btn-hover-bg: #f8e6e9;
            --bs-btn-hover-border-color: #DC3545;
            --bs-btn-active-color: #DC3545;
            --bs-btn-active-border-color: #DC3545;
            --bs-gradient: none;
        }

        .search:hover {
            background-color: rgba(253,246,222,.897);
        }

        .dropdown-toggle::after {
            display: none;
        }

        .dropdown-item:hover {
            background-color: #eaecf4;
        }

        .no-btn-style {
            padding: 6px 14px;
            background-color: var(--bs-tertiary-bg);
            border: 1px solid var(--bs-border-color);
            border-radius: 0 .375rem .375rem 0;
            color: inherit;
            box-shadow: none;
            height: 100%;
        }

        .filterCount {
            display: inline-flex;
            width: 24px;
            height: 24px;
            font-size: 14px;
            font-weight: 600;
            background-color: rgb(250,208,72);
            border-radius: 50%;
            align-items: center;
            justify-content: center;
        }

        .input-group {
            position: relative;
        }

            .input-group .dropdown .dropdown-menu {
                right: 0;
                left: auto;
            }

            .input-group .dropdown-menu {
                max-height: 60vh;
                overflow: auto;
                will-change: transform;
            }

        .dropdown-menu {
            max-width: 90vw;
            overflow-x: hidden;
        }

        .thumb {
            width: 64px;
            height: 64px;
            overflow: hidden;
            border-radius: 8px;
        }

            .thumb img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                display: block;
            }

        .thumbnail-container {
            position: relative;
            display: inline-block;
        }

        .thumb-img {
            width: 64px;
            height: 64px;
            object-fit: cover;
            border-radius: 8px;
            display: block;
            cursor: zoom-in;
        }

        .offcanvas-body img.offcanvas-img {
            max-width: 50%;
            height: auto;
            border-radius: 12px;
            display: block;
            margin: 0 auto 1rem;
        }

        /* hover 縮圖預覽 */
        #global-image-preview {
            position: fixed;
            display: none;
            top: 0;
            left: 0;
            width: 260px;
            max-height: 60vh;
            border: none !important;
            background: transparent !important;
            padding: 0 !important;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 8px 24px rgba(0,0,0,.2);
            z-index: 5000;
            pointer-events: none;
        }

            #global-image-preview img {
                width: 100%;
                height: auto;
                display: block;
            }

        .preview-img {
            display: none !important;
        }

        .thumbnail-container:hover .preview-img {
            display: none !important;
        }

        /* 表格外框線 */
        .table-bordered-gray {
            border: 1px solid gray !important;
        }

        /* ✅ 補上大括號：控制排程表寬度 */
        .custom-table-width {
            max-width: 1200px;
            margin: auto;
        }
    </style>
}


<main class="flex-fill position-relative">
    <div class="d-flex align-items-center mb-3">
        <h1 class="fw-bold flex-grow-1 mb-0">活動列表</h1>
        <button type="button"
                id="btnViewScheduled"
                class="btn btn-outline-search fw-bold me-2 position-relative"
                data-bs-toggle="modal"
                data-bs-target="#scheduledModal">
            <i class="fa-regular fa-calendar"></i> 檢視排程
            <span id="scheduledBadge"
                  class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-warning text-dark"
                  style="display:none">0</span>
        </button>
        <a asp-action="Create" class="btn btn-search fw-bold text-dark"><i class="fa-solid fa-star" style="color: #000000;"></i></i> 新增</a>
    </div>

    <form id="deleteForm">@Html.AntiForgeryToken()</form>

    <!-- 搜尋 -->
    <div class="input-group input-group-lg">
        <input id="searchInput" type="text" class="form-control" placeholder="請輸入關鍵字（活動名稱、種類、地點）以搜尋">
        <button type="button" class="text-danger input-group-text btn-outline-delect" id="btnClearKeyword" title="清除輸入">×</button>

        <button type="button" class="input-group-text search" id="btnSearch" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="所有活動" data-bs-trigger="hover">
            所有活動
        </button>

        <!-- 進階篩選 -->
        <div class="dropdown">
            <button class="input-group-text search dropdown-toggle dropdown-toggle-split no-btn-style position-relative"
                    type="button" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside"
                    data-bs-display="static" id="advancedFilter">
                <i class="fa-solid fa-chevron-down" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="進階篩選" data-bs-trigger="hover"></i>
                <span class="filterCount d-none position-absolute top-0 start-100 translate-middle" id="filterCount">0</span>
            </button>

            <ul class="dropdown-menu dropdown-menu-end p-2" style="width:220px">
                <!-- 活動種類 -->
                <li><button type="button" class="dropdown-item fw-bold ps-2" data-bs-toggle="collapse" data-bs-target="#collapseCategory">- 活動種類</button></li>
                <li>
                    <div class="collapse mb-2 ps-3 fs14px" id="collapseCategory">
                        <div class="p-2">
                            <div class="form-check"><input class="form-check-input" type="checkbox" value="星學課程" id="cat1"><label class="form-check-label" for="cat1">星學課程</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" value="星知講座" id="cat2"><label class="form-check-label" for="cat2">星知講座</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" value="星境營隊" id="cat3"><label class="form-check-label" for="cat3">星境營隊</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" value="星樂工作坊" id="cat4"><label class="form-check-label" for="cat4">星樂工作坊</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" value="星動旅程" id="cat5"><label class="form-check-label" for="cat5">星動旅程</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" value="星趣親子時光" id="cat6"><label class="form-check-label" for="cat6">星趣親子時光</label></div>
                        </div>
                    </div>
                </li>

                <!-- 狀態 -->
                <li><button type="button" class="dropdown-item fw-bold ps-2" data-bs-toggle="collapse" data-bs-target="#collapseStatus">- 目前狀態</button></li>
                <li>
                    <div class="collapse mb-2 ps-3 fs14px" id="collapseStatus">
                        <div class="p-2">
                            <div class="form-check"><input class="form-check-input" type="checkbox" value="報名中" id="status1"><label class="form-check-label" for="status1">報名中</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" value="已額滿" id="status2"><label class="form-check-label" for="status2">已額滿</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" value="已結束" id="status3"><label class="form-check-label" for="status3">已結束</label></div>
                            <div class="form-check"><input class="form-check-input" type="checkbox" value="已取消" id="status4"><label class="form-check-label" for="status4">已取消</label></div>
                        </div>
                    </div>
                </li>

                <!-- 開始日期 -->
                <li><button type="button" class="dropdown-item fw-bold ps-2" data-bs-toggle="collapse" data-bs-target="#collapseDate">- 開始日期</button></li>
                <li>
                    <div class="collapse mb-2 ps-1 fs14px" id="collapseDate">
                        <div class="p-2">
                            <div class="mb-2"><label for="dateFrom" class="form-label">起始日期</label><input type="date" id="dateFrom" class="form-control" lang="en-US"></div>
                            <div><label for="dateTo" class="form-label">結束日期</label><input type="date" id="dateTo" class="form-control" lang="en-US"></div>
                        </div>
                    </div>
                </li>

                <li><hr class="dropdown-divider"></li>
                <li class="d-flex gap-1">
                    <button type="button" class="br20px fw-bold btn flex-fill btn-search" id="filterFinsh">完成</button>
                    <button type="button" class="br20px fw-bold btn flex-fill btn-outline-search" id="btnClear">清除</button>
                </li>
            </ul>
        </div>
    </div>

    <div class="mt-1 text-end me-2" style="display:none" id="selectedFiltersDiv">
        <span id="selectedFiltersText" class="text-secondary"></span>
    </div>

    <!-- 列表 -->
    <div class="table-rounded position-relative mt-3">
        <table class="table">
            <thead>
                <tr>
                    <th style="width:50px">
                        <input class="form-check-input ms-4" type="checkbox" id="checkAll" data-bs-toggle="tooltip" data-bs-placement="bottom" data-bs-title="全選" data-bs-trigger="hover">
                    </th>
                    <th style="width:86px">圖片</th>
                    <th style="width:346px">活動名稱</th>
                    <th>活動種類</th>
                    <th>目前狀態</th>
                    <th>開始時間</th>
                    <th>活動地點</th>
                    <th>活動費用</th>
                    <th style="width:116px"></th>
                </tr>
            </thead>
            <tbody id="tableBody">
                @await Html.PartialAsync("_EventRows", Model)
            </tbody>
        </table>

        <div id="pagination">
            @await Html.PartialAsync("~/Views/Events/_EventPagination.cshtml")
        </div>

        <div class="float-end position-absolute top-0 end-0 me-4 mt-2 d-flex justify-content-center selectColor">
            <span id="selectNum" style="display:none" class="text-warning fw-bold fs18px me-2">已選取0項</span>
            <button type="button" class="text-danger btn p-0 selectColor fs18px" id="deleteAllBtn" data-bs-toggle="modal" data-bs-target="#deleteAllModal" style="display:none">
                <i class="fa-solid fa-trash-can"></i>
            </button>
        </div>

        <div class="modal fade" id="deleteAllModal" tabindex="-1" aria-labelledby="deleteAllModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header"><h5 class="modal-title" id="deleteAllModalLabel">確認刪除</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
                    <div class="modal-body">確定要刪除已選取的所有活動嗎？</div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-delect br20px" id="deleteAllYes" data-bs-dismiss="modal">確定刪除</button>
                        <button type="button" class="btn btn-secondary br20px" data-bs-dismiss="modal">取消</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Offcanvas（詳細） -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasDetail">
        <div class="offcanvas-header justify-content-between d-flex align-items-center pt-3 pb-2">
            <h3 class="offcanvas-title fw-bolder">詳細內容</h3>
            <div class="d-flex justify-content-end align-items-center gap-2">
                <a id="offcanvasEditBtn" class="btn btn-primary br20px"><i class="fa-solid fa-pen-to-square"></i>編輯</a>
                <button type="button" class="btn btn-outline-delect br20px" id="offcanvasDeleteBtn" data-bs-toggle="modal" data-bs-target="#deleteModal"><i class="fa-solid fa-trash-can"></i>刪除</button>
                <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
            </div>

            <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true" data-bs-backdrop="false">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header"><h5 class="modal-title" id="deleteModalLabel">確認刪除</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                        <div class="modal-body">你確定要刪除這筆資料嗎？</div>
                        <div class="modal-footer">
                            <form id="deleteOne" asp-action="Delete" method="post" class="d-inline">
                                @Html.AntiForgeryToken()
                                <button type="submit" class="btn btn-outline-delect br20px" id="deleteOnebtn">確定刪除</button>
                            </form>
                            <button type="button" class="btn btn-secondary br20px" data-bs-dismiss="modal">取消</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="offcanvas-body">
            <img id="offcanvasImage" src="" alt="活動圖片" class="offcanvas-img" />
            <p><strong>活動名稱：</strong><span id="offcanvasTitle"></span></p>
            <p><strong>活動種類：</strong><span id="offcanvasCategory"></span></p>
            <p><strong>活動地點：</strong><span id="offcanvasLocation"></span></p>
            <p><strong>人數上限：</strong><span id="offcanvasMax"></span></p>
            <p><strong>目前狀態：</strong><span id="offcanvasStatus"></span></p>
            <hr />
            <p><strong>開始時間：</strong><span id="offcanvasStart"></span></p>
            <p><strong>結束時間：</strong><span id="offcanvasEnd"></span></p>
            <p><strong>建立日期：</strong><span id="offcanvasCreated"></span></p>
            <p><strong>最後更新日期：</strong><span id="offcanvasUpdated"></span></p>
            <hr />
            <p><strong>活動費用：</strong><span id="offcanvasFee"></span></p>
            <p><strong>預定訂金：</strong><span id="offcanvasDeposit"></span></p>
            <p><strong>活動說明：</strong><span id="offcanvasDesc"></span></p>
        </div>
    </div>

    <div class="modal fade" id="scheduledModal" tabindex="-1" aria-labelledby="scheduledModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 clas s="modal-title fw-bold" id="scheduledModalLabel">排程中的活動</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="關閉"></button>
                </div>
                <div class="modal-body">
                    
                    <div class="custom-table-width">
                        <table class="table table-hover align-middle mb-0 table-bordered-gray text-center">
                            <thead class="table-light align-items-center">
                                <tr>
                                    <th style="width:120px">圖片</th>
                                    <th>活動名稱</th>
                                    <th style="width:140px">活動種類</th>
                                    <th style="width:160px">發布時間</th>
                                    <th style="width:120px">目前狀態</th>
                                    <th style="width:180px">操作</th>
                                </tr>
                            </thead>
                            <tbody id="scheduledTbody" class="align-content-center">
                                <!-- 由 JS 動態塞入 -->
                            </tbody>
                        </table>
                        <div id="scheduledEmpty" class="text-secondary" style="display:none;">目前沒有排程中的活動。</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <small class="text-secondary me-auto">*發佈日期大於現在時間，且尚未發佈。</small>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
                </div>
            </div>
        </div>
    </div>
</main>

@section Scripts {
    <script>
        // ====== 全域參數（從伺服端帶入） ======
        const pageNumber = @((ViewBag.PageSize ?? 10));
        const initStatus  = @Html.Raw(JsonSerializer.Serialize(ViewBag.Status as string ?? ""));
        const initKeyword = @Html.Raw(JsonSerializer.Serialize(ViewBag.Keyword as string ?? ""));

        let currentFilters = {
          categories: [],
          statuses:  initStatus ? [initStatus] : [],
          dateFrom: '',
          dateTo: '',
          keyword:  initKeyword
        };

        // ====== 換頁（統一用 SearchSelect） ======
        function loadPage(page) {
          refreshEventsTable(page, currentFilters);
        }

        // ====== AJAX 刷新（唯一版本，請勿重複定義） ======
        async function refreshEventsTable(page = 1, filters = currentFilters) {
          try {
          function sanitizeFilters(f){
          const de = s => $('<textarea/>').html(String(s)).text(); // 解 HTML Entity
          const o = {...f};
          o.categories = (o.categories||[]).map(s=>de(s).trim()).filter(Boolean);
          o.statuses   = (o.statuses||[]).map(s=>de(s).trim()).filter(Boolean);
          o.keyword    = de(o.keyword||'').trim();
          if (!o.categories.length) delete o.categories;
          if (!o.statuses.length)   delete o.statuses;
          if (!o.keyword)           delete o.keyword;
          if (!o.dateFrom)          delete o.dateFrom;
          if (!o.dateTo)            delete o.dateTo;
          return o;
        }

            const payload = { ...filters, page, pageSize: pageNumber };
            console.debug('[SearchSelect] request:', payload);

            const response = await $.ajax({
              url: '/Events/SearchSelect',
              type: 'POST',
              data: JSON.stringify(payload),
              contentType: 'application/json; charset=utf-8'
            });

            console.debug('[SearchSelect] response:', {
              page: response.page, total: response.total,
              totalPages: response.totalPages, status: response.status, keyword: response.keyword
            });

            const srvPage       = Number(response.page ?? page) || 1;
            // const srvTotal      = Number(response.total ?? 0);
            const srvTotalPages = Math.max(1, Number(response.totalPages ?? 1));

            // 更新表格與分頁
            if (typeof response === 'string') {
              $('#tableBody').html(response);
            } else {
              $('#tableBody').html(response.tableHtml || '');
              if (response.paginationHtml) $('#pagination').html(response.paginationHtml);
            }

            // 更新頁碼顯示
            $('#paginationInfo').text(srvPage);

            // 清理選取狀態
            $('#checkAll').prop('checked', false);
            $('#deleteAllBtn, #selectNum').hide();
          } catch (err) {
            alert('更新列表失敗：' + (err.responseText || err.statusText || err.message));
          }
        }

        // ====== DOM Ready ======
        $(function () {
          const getToken = () => $('input[name="__RequestVerificationToken"]').val();

          // 修正下拉選單彈出位置抖動
          (function fixDropdownJump() {
            const toggle = document.getElementById('advancedFilter');
            if (!toggle) return;
            const inst = bootstrap.Dropdown.getInstance(toggle);
            if (inst) inst.dispose();
            new bootstrap.Dropdown(toggle, {
              popperConfig: {
                strategy: 'fixed',
                modifiers: [
                  { name: 'offset', options: { offset: [0, 8] } },
                  { name: 'preventOverflow', options: { boundary: document.body } },
                  { name: 'computeStyles', options: { adaptive: false } }
                ]
              },
              autoClose: 'outside'
            });
          })();

          // —— 初始 UI：從總覽帶來的條件回填 —— //
          (function syncInitialFiltersToUI(){
            if (initKeyword) { $('#searchInput').val(initKeyword); $('#btnClearKeyword').show(); }
            if (initStatus)  { $(`#collapseStatus input.form-check-input[value="${initStatus}"]`).prop('checked', true); }
            updateFilterCount();
            updateSelectedFilters();
          })();

          // 小×清除輸入
          (function () {
            const input = document.getElementById('searchInput');
            const btnX  = document.getElementById('btnClearKeyword');
            if (!input || !btnX) return;
            const toggleX = () => { btnX.style.display = input.value.trim() ? '' : 'none'; };
            toggleX();
            input.addEventListener('input', toggleX);
            btnX.addEventListener('click', function () { input.value = ''; input.focus(); toggleX(); });
          })();

          // checkbox 勾選/全選
          $(document).on('click', '.checkbox', function () {
            const checked = $(this).prop('checked');
            const count = $('.checkbox:checked').length;
            $(this).closest('tr').toggleClass('active', checked);
            if (count > 0) { $('#deleteAllBtn, #selectNum').show(); $('#selectNum').text(`已選取${count}項`); }
            else { $('#deleteAllBtn, #selectNum').hide(); }
            $('#checkAll').prop('checked', $('.checkbox').length === $('.checkbox:checked').length);
          });

          $('#checkAll').on('click', function () {
            const checked = $(this).prop('checked');
            $('.checkbox').prop('checked', checked);
            $('tbody tr').toggleClass('active', checked);
            if (checked) {
              const count = $('.checkbox:checked').length;
              if (count > 0) { $('#deleteAllBtn, #selectNum').show(); $('#selectNum').text(`已選取${count}項`); }
            } else {
              $('#deleteAllBtn, #selectNum').hide();
            }
          });

          // 批次刪除
          $('#deleteAllYes').on('click', function () {
            const ids = $('.checkbox:checked').map(function () { return $(this).val(); }).get();
            if (ids.length === 0) return;
            $.ajax({
              url: '/Events/DeleteMultiple',
              type: 'POST',
              data: { __RequestVerificationToken: getToken(), ids },
              traditional: true
            }).done(function () {
              const page = parseInt($('#paginationInfo').text()) || 1;
              refreshEventsTable(page, currentFilters);
              $('#deleteAllBtn, #selectNum').hide();
              $('#checkAll').prop('checked', false);
            }).fail(function () {
              alert('刪除失敗！');
            });
          });

          // 搜尋與即時輸入（統一用 SearchSelect）
          $('#btnSearch').on('click', function(){
            collectFilters();
            refreshEventsTable(1, currentFilters);
          });
          $('#searchInput').on('keyup', function(){
            collectFilters();
            refreshEventsTable(1, currentFilters);
          });

          // 進階篩選 完成
          $('#filterFinsh').on('click', function () {
            collectFilters();
            updateFilterCount();
            updateSelectedFilters();
            refreshEventsTable(1, currentFilters);
            const toggleBtn = $(this).closest('.dropdown').find('.dropdown-toggle')[0];
            (bootstrap.Dropdown.getInstance(toggleBtn) || new bootstrap.Dropdown(toggleBtn)).hide();
          });

          // 清除進階篩選（不動關鍵字）
          $('#btnClear').on('click', function (e) {
            e.preventDefault();
            const $menu = $(this).closest('.dropdown-menu');
            $menu.find('input[type=checkbox]:checked').prop('checked', false);
            $menu.find('#dateFrom, #dateTo').val('');
            collectFilters();
            updateSelectedFilters();
            updateFilterCount();
            refreshEventsTable(1, currentFilters);
            const toggleBtn = $(this).closest('.dropdown').find('.dropdown-toggle')[0];
            (bootstrap.Dropdown.getInstance(toggleBtn) || new bootstrap.Dropdown(toggleBtn)).hide();
          });

          // 日期區間限制
          (function(){
            const dateFrom = document.getElementById('dateFrom');
            const dateTo   = document.getElementById('dateTo');
            if (!dateFrom || !dateTo) return;
            dateFrom.addEventListener('change', () => {
              if (dateFrom.value) {
                dateTo.min = dateFrom.value;
                if (dateTo.value && dateTo.value < dateFrom.value) dateTo.value = '';
              } else {
                dateTo.min = '';
              }
            });
          })();

          // 分頁代理（單一路徑；避免捲動到頂）
          $(document).on('click', '.pagination .page-link', function (e) {
            e.preventDefault();
            e.stopPropagation();
            const $item = $(this).closest('.page-item');
            if ($item.hasClass('disabled') || $item.hasClass('active')) return false;
            const page = Number($(this).data('page'));
            if (!Number.isFinite(page) || page < 1) return false;
            loadPage(page);
            return false;
          });

          // Offcanvas 詳細
          $(document).on('click', '.btn-detail', function () {
            const btn = $(this);
            $('#offcanvasTitle').text(btn.data('title') || '');
            $('#offcanvasCategory').text(btn.data('category') || '');
            $('#offcanvasStatus').text(btn.data('status') || '');
            $('#offcanvasStart').text(btn.data('start') || '');
            $('#offcanvasEnd').text(btn.data('end') || '');
            $('#offcanvasCreated').text(btn.data('created') || '');
            $('#offcanvasUpdated').text(btn.data('updated') || '');
            $('#offcanvasLocation').text(btn.data('location') || '');
            const feeVal = btn.data('fee');
            $('#offcanvasFee').text(feeVal == null ? '' : (Number(feeVal) === 0 ? '免付費' : feeVal));
            const depVal = btn.data('deposit');
            $('#offcanvasDeposit').text(depVal == null ? '' : (Number(depVal) === 0 ? '免付費' : depVal));

            $('#offcanvasDesc').text(btn.data('desc') || '');
            const max = btn.data('maxParticipants') ?? btn.data('maxparticipants');
            $('#offcanvasMax').text(max ?? '');
            $('#offcanvasImage').attr('src', btn.data('image') || '/img/logo.png');

            const id = btn.data('id');
            $('#offcanvasEditBtn').attr('href', '/Events/Edit/' + id);
            $('#deleteModal').off('show.bs.modal').on('show.bs.modal', function () {
              $('#deleteOne').attr('action', '/Events/Delete/' + id);
            });

            bootstrap.Offcanvas.getOrCreateInstance(document.getElementById('offcanvasDetail')).show();
          });

          // 檢視排程中的活動（Modal）
          (function scheduledModalFeature(){
            const $modal = $('#scheduledModal');
            const $tbody = $('#scheduledTbody');
            const $empty = $('#scheduledEmpty');
            const $badge = $('#scheduledBadge');

            function fmt(dtStr){
              if(!dtStr) return '';
              const d = new Date(dtStr);
              if (isNaN(d)) return dtStr;
              const pad = (n)=>String(n).padStart(2,'0');
              return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
            }

            function htmlRow(x){
              const img = x.image || '/img/logo.png';
              return `
                <tr>
                  <td>
                    <div class="thumbnail-container">
                      <img src="${img}" class="thumb-img" alt="img" style="width:64px;height:64px;object-fit:cover;border-radius:8px">
                    </div>
                  </td>
                  <td class="fw-semibold">${x.title ?? ''}</td>
                  <td>${x.category ?? ''}</td>
                  <td>${fmt(x.releaseDate)}</td>
                  <td>${x.status ?? ''}</td>
                  <td>
                    <a class="btn btn-sm btn-primary br20px me-1" href="/Events/Edit/${x.no}">
                      <i class="fa-solid fa-pen-to-square"></i> 編輯
                    </a>
                  </td>
                </tr>`;
            }

            async function refreshBadge(){
              try{
                const res = await $.get('/Events/GetScheduledCount');
                const n = res?.count ?? 0;
                if(n>0){ $badge.text(n).show(); } else { $badge.hide(); }
              }catch(_){ $badge.hide(); }
            }

            async function loadScheduled(){
              $tbody.empty();
              $empty.hide();
              try{
                const list = await $.get('/Events/GetScheduled');
                if(!list || list.length===0){
                  $empty.show();
                  return;
                }
                $tbody.html(list.map(htmlRow).join(''));
              }catch(err){
                $empty.text('載入失敗：' + (err.responseText || err.statusText || err.message)).show();
              }
            }

            $modal.on('show.bs.modal', loadScheduled);
            $(refreshBadge);
            setInterval(refreshBadge, 90000);
          })();

          // 單筆刪除
          $(document).on('click', '#deleteOnebtn', async function (e) {
            e.preventDefault();
            const action = $(this).closest('form').attr('action');
            const id = action?.split('/').pop();
            if (!id) return;
            try {
              await $.ajax({ url: '/Events/Delete', type: 'POST', data: { id, __RequestVerificationToken: getToken() } });
              const page = parseInt($('#paginationInfo').text()) || 1;
              refreshEventsTable(page, currentFilters);
              const oc = bootstrap.Offcanvas.getInstance(document.getElementById('offcanvasDetail'));
              if (oc) oc.hide();
              $('#deleteModal').modal('hide');
            } catch (err) {
              alert('刪除失敗：' + (err.responseText || err.statusText));
            }
          });

          // ===== 搜尋/篩選 =====
          function collectFilters() {
            const categories = [...document.querySelectorAll('#collapseCategory input:checked')].map(cb => cb.value);
            const statuses   = [...document.querySelectorAll('#collapseStatus input:checked')].map(cb => cb.value);
            const keyword    = $('#searchInput').val();
            const df         = $('#dateFrom').val();
            const dt         = $('#dateTo').val();
            currentFilters = { categories, statuses, dateFrom: df, dateTo: dt, keyword };
            return currentFilters;
          }

          function updateSelectedFilters() {
            const selected = [];
            const cats = $('#collapseCategory input:checked').map(function(){ return $(this).next('label').text(); }).get();
            if (cats.length) selected.push('<strong>種類：</strong>' + cats.join(', '));
            const sts  = $('#collapseStatus input:checked').map(function(){ return $(this).next('label').text(); }).get();
            if (sts.length) selected.push('<strong>狀態：</strong>' + sts.join(', '));
            const from = $('#dateFrom').val(), to = $('#dateTo').val();
            if (from || to) selected.push('<strong>日期：</strong>' + (from?from:'不限') + ' ~ ' + (to?to:'不限'));
            if (selected.length){ $('#selectedFiltersDiv').show(); $('#selectedFiltersText').html(selected.join('&nbsp;&nbsp;&nbsp;&nbsp;')); }
            else { $('#selectedFiltersDiv').hide(); $('#selectedFiltersText').html(''); }
          }

          function updateFilterCount() {
            let count = 0;
            if ($('#collapseCategory input:checked').length > 0) count++;
            if ($('#collapseStatus input:checked').length   > 0) count++;
            if ($('#dateFrom').val() || $('#dateTo').val()) count++;
            const $badge = $('#filterCount');
            if (count > 0) { $badge.text(count).removeClass('d-none'); }
            else { $badge.addClass('d-none'); }
          }
        });

        // 影像預覽（與列表無關，保留你的實作）
        (function attachGlobalPreview(){
          const box = document.createElement('div');
          box.id = 'global-image-preview';
          box.innerHTML = '<img alt="預覽">';
          document.body.appendChild(box);
          const img = box.querySelector('img');

          $(document).on('mouseenter', '.thumbnail-container .thumb-img', function(e){
            const src = $(this).attr('src') || $(this).data('src');
            if(!src) return;
            img.src = src;
            box.style.display = 'block';
            positionBox(e);
          });

          $(document).on('mousemove', '.thumbnail-container .thumb-img', function(e){
            positionBox(e);
          });

          $(document).on('mouseleave', '.thumbnail-container .thumb-img', function(){
            box.style.display = 'none';
            img.src = '';
          });

          function positionBox(e){
            const padding = 16, w = box.offsetWidth || 260, h = box.offsetHeight || 200;
            const vw = window.innerWidth, vh = window.innerHeight;
            let x = e.clientX + padding, y = e.clientY + padding;
            if (x + w > vw) x = e.clientX - w - padding;
            if (y + h > vh) y = e.clientY - h - padding;
            box.style.left = x + 'px'; box.style.top  = y + 'px';
          }
        })();
    </script>
}


