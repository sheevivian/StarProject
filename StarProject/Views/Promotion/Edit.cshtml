@model StarProject.ViewModels.PromotionFormViewModel
@{
    ViewData["Title"] = "編輯優惠券";
}

<head>
    <link href="~/css/promotion.css" rel="stylesheet" />
    <style>
        .no-spinner::-webkit-inner-spin-button,
        .no-spinner::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .no-spinner {
            -moz-appearance: textfield;
        }
    </style>
</head>

<div class="card shadow-sm">
    <div class="card-header bg-primary text-white">
        <h4 class="mb-0"><i class="fi fi-ss-money-wings me-2"></i>編輯優惠券</h4>
    </div>

    <div class="card-body">
        <form asp-action="Edit" method="post" id="promotionForm">
            <input type="hidden" asp-for="No" />
            <input type="hidden" asp-for="LimitMode" id="limitMode" />
            <input type="hidden" asp-for="UsesTimeMode" id="usesTimeMode" />

            <!-- 基本資訊 -->
            <fieldset class="border rounded p-3 mb-3">
                <legend class="w-auto px-2 fs-6 fw-bold">基本資訊</legend>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label asp-for="Name" class="form-label">優惠名稱 <span class="text-danger">*</span></label>
                        <input asp-for="Name" class="form-control" required />
                        <span asp-validation-for="Name" class="text-danger small"></span>
                        <div id="duplicateNameAlert" class="text-danger small mt-1" style="display:none;">優惠名稱已存在！</div>
                        <!-- ★ 修改：加入「名稱已存在」的就地提示 -->
                    </div>

                    <div class="col-md-6 mb-3">
                        <label asp-for="CouponCode" class="form-label">優惠代碼 <span class="text-danger">*</span></label>
                        <input asp-for="CouponCode" class="form-control" style="text-transform: uppercase;"
                               oninput="this.value = this.value.toUpperCase();" required />
                        <span asp-validation-for="CouponCode" class="text-danger small"></span>
                        <div id="duplicateCodeAlert" class="text-danger small mt-1" style="display:none;">優惠代碼已存在！</div>
                        <!-- ★ 修改：加入「代碼已存在」的就地提示 -->
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label asp-for="Category" class="form-label">適用類別 <span class="text-danger">*</span></label>
                        <select asp-for="Category" asp-items="Model.CategoryOptions" class="form-select" required>
                            <option value="">請選擇</option>
                        </select>
                        <span asp-validation-for="Category" class="text-danger small"></span>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label asp-for="Status" class="form-label">狀態 <span class="text-danger">*</span></label>
                        <select asp-for="Status" asp-items="Model.StatusOptions" class="form-select" required>
                            <option value="">請選擇</option>
                        </select>
                        <span asp-validation-for="Status" class="text-danger small"></span>
                    </div>
                </div>
            </fieldset>

            <!-- 有效期間 -->
            <fieldset class="border rounded p-3 mb-3">
                <legend class="w-auto px-2 fs-6 fw-bold">有效期間</legend>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label asp-for="StartDate" class="form-label">開始時間 <span class="text-danger">*</span></label>
                        <input asp-for="StartDate" type="datetime-local" class="form-control" step="60" required />
                        <span asp-validation-for="StartDate" class="text-danger small"></span>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label asp-for="EndDate" class="form-label">結束時間 <span class="text-danger">*</span></label>
                        <input asp-for="EndDate" type="datetime-local" class="form-control" step="60" required />
                        <span asp-validation-for="EndDate" class="text-danger small"></span>
                    </div>
                </div>
            </fieldset>

            <!-- 使用限制 -->
            <fieldset class="border rounded p-3 mb-3">
                <legend class="w-auto px-2 fs-6 fw-bold">使用限制</legend>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label class="form-label">優惠券總數量限制</label>
                        <div class="input-group">
                            <input asp-for="Limit" class="form-control" placeholder="不填則無限制" type="number" min="0" onchange="updateLimitMode(this)" />
                            <span class="input-group-text">張</span>
                        </div>
                        <span asp-validation-for="Limit" class="text-danger small"></span>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">每人使用次數</label>
                        <div class="input-group">
                            <input asp-for="UsesTime" id="UsesTime" class="form-control" placeholder="1" type="number" min="0" onchange="updateUsesTimeMode(this)" />
                            <span class="input-group-text">次</span>
                        </div>
                        <span asp-validation-for="UsesTime" class="text-danger small"></span>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label d-block">&nbsp;</label>
                        <div class="form-check">
                            <input asp-for="Reuse" id="Reuse" class="form-check-input" type="checkbox" />
                            <label asp-for="Reuse" class="form-check-label">會員可重複使用</label>
                        </div>
                    </div>
                </div>
            </fieldset>

            <!-- 優惠規則 -->
            <fieldset class="border rounded p-3 mb-3">
                <legend class="w-auto px-2 fs-6 fw-bold">優惠規則</legend>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label asp-for="RuleType" class="form-label">折扣類型 <span class="text-danger">*</span></label>
                        <select asp-for="RuleType" asp-items="Model.RuleTypeOptions" class="form-select" onchange="updateDiscountHint(this.value)" required>
                            <option value="">請選擇</option>
                        </select>
                        <span asp-validation-for="RuleType" class="text-danger small"></span>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label asp-for="DiscountValue" class="form-label">折扣數值</label>
                        <div class="input-group">
                            <input asp-for="DiscountValue" id="DiscountValue" class="form-control" type="number" min="0" step="0.01" />
                            <span class="input-group-text" id="discountUnit">元</span>
                        </div>
                        <small id="discountHint" class="text-muted"></small>
                        <span asp-validation-for="DiscountValue" class="text-danger small d-block"></span>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label asp-for="ConditionType" class="form-label">門檻類型</label>
                        <select asp-for="ConditionType" id="ConditionType" asp-items="Model.ConditionTypeOptions" class="form-select" onchange="toggleConditionFields(this.value)">
                        </select>
                        <span asp-validation-for="ConditionType" class="text-danger small"></span>
                    </div>
                    <div class="col-md-6 mb-3" id="amountCondition">
                        <label asp-for="ConditionAmount" class="form-label">消費門檻</label>
                        <div class="input-group">
                            <span class="input-group-text">滿</span>
                            <input asp-for="ConditionAmount" id="ConditionAmount" class="form-control no-spinner" placeholder="0" type="number" min="0" />
                            <span class="input-group-text">元</span>
                        </div>
                        <small class="text-muted">設定最低消費金額，0 或不填表示無門檻</small>
                        <span asp-validation-for="ConditionAmount" class="text-danger small"></span>
                    </div>
                    <div class="col-md-6 mb-3" id="memberCondition" style="display:none;">
                        <label asp-for="MemberLevel" class="form-label">會員等級</label>
                        <select asp-for="MemberLevel" id="MemberLevel" class="form-select">
                            <option value="">請選擇</option>
                            <option value="Bronze">銅級會員</option>
                            <option value="Silver">銀級會員</option>
                            <option value="Gold">金級會員</option>
                            <option value="Platinum">白金會員</option>
                        </select>
                        <span asp-validation-for="MemberLevel" class="text-danger small"></span>
                    </div>
                </div>

                <div class="row">
                    <div class="col-12 mb-3">
                        <label asp-for="Description" class="form-label">優惠說明 <span class="text-danger">*</span></label>
                        <textarea asp-for="Description" class="form-control" rows="3" placeholder="請詳細說明優惠內容、使用條件等資訊" required></textarea>
                        <span asp-validation-for="Description" class="text-danger small"></span>
                    </div>
                </div>
            </fieldset>

            <div class="d-flex justify-content-end gap-2">
                <a asp-action="Index" class="btn btn-secondary"><i class="fa-solid fa-xmark me-2"></i>取消</a>
                <button type="submit" class="btn btn-primary" id="submitBtn"><i class="fa-solid fa-check me-2"></i>儲存修改</button>
            </div>
        </form>
    </div>
</div>

<!-- ★ 新增：表單驗證錯誤（Danger）Modal：置中、圓角、danger色 -->
<div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel"
     aria-hidden="true" data-bs-backdrop="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content modal-danger">
            <!-- ★ 使用 promotion.css 的 .modal-danger -->
            <div class="modal-header">
                <h5 class="modal-title" id="errorModalLabel">表單驗證錯誤</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="bg-white rounded p-2">
                    @Html.ValidationSummary(excludePropertyErrors: true)  <!-- 只顯示模型層級錯誤 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary br20px" data-bs-dismiss="modal">我知道了</button>
            </div>
        </div>
    </div>
</div>

@* ★ 旗標：伺服器端有錯（ModelState/PopupError）就讓前端自動彈出 *@
@if (!ViewData.ModelState.IsValid || !string.IsNullOrEmpty(ViewBag.PopupError as string))
{
    <div id="serverHasError" data-error="1"></div>
}

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // ★ 有錯就彈出錯誤 Modal
            var hasError = document.getElementById('serverHasError');
            if (hasError) {
                var modal = new bootstrap.Modal(document.getElementById('errorModal'));
                modal.show();
            }

            // 初始化折扣提示 & 門檻顯示
            updateDiscountHint(document.getElementById('RuleType').value || '');
            toggleConditionFields(document.getElementById('ConditionType').value || 'Amount');

            // 名稱/代碼重複檢查（Edit -> 帶 id 排除自己）
            const codeInput = document.getElementById('CouponCode');
            const nameInput = document.getElementById('Name');
            const id = document.getElementById('No').value;

            function triggerDupCheck() {
                const code = codeInput.value || '';
                const name = nameInput.value || '';
                if (!code && !name) return;

                fetch('@Url.Action("CheckDuplicate", "Promotion")', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'RequestVerificationToken': document.querySelector('[name="__RequestVerificationToken"]').value
                    },
                    body: 'couponCode=' + encodeURIComponent(code) +
                          '&name=' + encodeURIComponent(name) +
                          '&id=' + encodeURIComponent(id)
                }).then(r => r.json()).then(res => {
                    document.getElementById('duplicateCodeAlert').style.display = res.duplicateCode ? 'block' : 'none';
                    document.getElementById('duplicateNameAlert').style.display = res.duplicateName ? 'block' : 'none';
                });
            }
            codeInput.addEventListener('blur', triggerDupCheck);
            nameInput.addEventListener('blur', triggerDupCheck);

            // 可重複 -> 每人次數至少 2
            const uses = document.getElementById('UsesTime');
            const usesMode = document.getElementById('usesTimeMode');
            document.getElementById('Reuse').addEventListener('change', function () {
                if (this.checked) {
                    if (!uses.value || parseInt(uses.value, 10) < 2) uses.value = '2';
                    usesMode.value = 'limited';
                }
            });

            // 防重送
            var form = document.getElementById('promotionForm');
            var isSubmitting = false;
            if (form) {
                form.addEventListener('submit', function (e) {
                    if (isSubmitting) { e.preventDefault(); return false; }
                    isSubmitting = true;
                    document.getElementById('submitBtn').disabled = true;
                    document.getElementById('submitBtn').innerHTML = '<i class="fa-solid fa-spinner fa-spin me-2"></i>儲存中...';
                });
            }
        });

        // ====== 共用互動 ======
        function updateLimitMode(input) {
            document.getElementById('limitMode').value = (input.value && input.value !== '0') ? 'limited' : 'unlimited';
        }
        function updateUsesTimeMode(input) {
            document.getElementById('usesTimeMode').value = (input.value && input.value !== '0') ? 'limited' : 'unlimited';
        }
        function toggleConditionFields(conditionType) {
            var amountCondition = document.getElementById('amountCondition');
            var memberCondition = document.getElementById('memberCondition');
            var conditionAmount = document.getElementById('ConditionAmount');
            var memberLevel = document.getElementById('MemberLevel');

            if (conditionType === 'MemberLevel') {
                amountCondition.style.display = 'none';
                memberCondition.style.display = 'block';
                if (conditionAmount) conditionAmount.value = '';
            } else {
                amountCondition.style.display = 'block';
                memberCondition.style.display = 'none';
                if (memberLevel) memberLevel.value = '';
            }
        }
        function updateDiscountHint(ruleType) {
            var unit = document.getElementById('discountUnit');
            var hint = document.getElementById('discountHint');
            var discountInput = document.getElementById('DiscountValue');

            switch (ruleType) {
                case 'FixedAmount':
                    unit.textContent = '元';
                    hint.textContent = '輸入固定折扣金額';
                    discountInput.disabled = false; break;
                case 'Percentage':
                    unit.textContent = '倍';
                    hint.textContent = '輸入折扣乘數 (例：0.9=九折；0.85=85折)';
                    discountInput.disabled = false; break;
                case 'FreeShipping':
                    unit.textContent = '';
                    hint.textContent = '免運費優惠，無需輸入數值';
                    discountInput.value = '80';
                    discountInput.disabled = true; break;
                case 'BuyXGetY':
                    unit.textContent = '元';
                    hint.textContent = '請輸入附贈商品金額';
                    discountInput.disabled = false; break;
                default:
                    unit.textContent = '';
                    hint.textContent = '';
                    discountInput.disabled = false; break;
            }
        }
    </script>
}
